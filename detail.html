<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi ti·∫øt phim</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .header-links a { color: white; margin-left: 20px; font-weight: bold; text-decoration: none;}
        .save-btn { background-color: #e50914; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 20px; font-weight: bold; width: 100%; transition: 0.2s;}
        .save-btn.saved { background-color: #333; }
        .save-btn:hover { background-color: #ff0a16; }
        
        /* CSS L√ÄM ƒê·∫∏P TH√îNG TIN V√Ä N√öT DI·ªÑN VI√äN */
        .meta-info { margin: 15px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 14px; line-height: 1.6; border: 1px solid rgba(255,255,255,0.1);}
        .meta-info span { color: #aaa; display: inline-block; width: 85px;}
        .meta-info strong { color: #fff; font-weight: 500;}
        
        .actor-tag {
            display: inline-block; background: rgba(255,255,255,0.15); color: #fff;
            padding: 4px 10px; border-radius: 15px; margin: 3px 3px 3px 0;
            text-decoration: none; font-size: 13px; transition: 0.2s;
        }
        .actor-tag:hover { background: #e50914; color: white; transform: scale(1.05);}
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="logo">NETFLIX FAKE</a>
        <div class="header-links"><a href="tu-phim.html">‚ù§Ô∏è T·ªß Phim</a></div>
    </header>

    <div class="container" id="detailContainer">
        <div class="loader" id="loader"></div>
    </div>

    <script>
        const API_DETAIL = 'https://ophim1.com/v1/api/phim/';
        
        const container = document.getElementById('detailContainer');
        const loader = document.getElementById('loader');
        const urlParams = new URLSearchParams(window.location.search);
        const slug = urlParams.get('slug');

        let savedMovies = JSON.parse(localStorage.getItem('savedMovies')) || {};

        async function loadDetail() {
            if (!slug) return container.innerHTML = '<h2>Kh√¥ng t√¨m th·∫•y m√£ phim!</h2>';
            loader.style.display = 'block';
            
            try {
                const response = await fetch(API_DETAIL + slug);
                const data = await response.json();
                loader.style.display = 'none';

                if (data.status !== 'success' && data.status !== true) return container.innerHTML = '<h2>Phim kh√¥ng t·ªìn t·∫°i.</h2>';

                const movie = (data.data && data.data.item) ? data.data.item : data.movie;
                if (!movie) return container.innerHTML = '<h2>L·ªói c·∫•u tr√∫c d·ªØ li·ªáu phim.</h2>';

                const episodes = (data.data && data.data.item && data.data.item.episodes) ? data.data.item.episodes : (data.episodes || movie.episodes || []);

                let imgDomain = (data.data && data.data.APP_DOMAIN_CDN_IMAGE) ? data.data.APP_DOMAIN_CDN_IMAGE : 'https://img.ophim.live';
                let posterUrl = movie.thumb_url || movie.poster_url;
                if (posterUrl && !posterUrl.startsWith('http')) posterUrl = `${imgDomain}/uploads/movies/${posterUrl}`;

                const contentText = movie.content ? movie.content.replace(/(<([^>]+)>)/gi, "") : 'ƒêang c·∫≠p nh·∫≠t...';
                
                // ================= X·ª¨ L√ù N√öT DI·ªÑN VI√äN B·∫§M ƒê∆Ø·ª¢C =================
                let actorsHTML = '<span style="color:#aaa;">ƒêang c·∫≠p nh·∫≠t</span>';
                if (movie.actor && movie.actor.length > 0 && movie.actor[0] !== "") {
                    // Bi·∫øn m·ªói t√™n di·ªÖn vi√™n th√†nh 1 th·∫ª <a> chuy·ªÉn h∆∞·ªõng v·ªÅ index.html k√®m l·ªánh t√¨m ki·∫øm
                    actorsHTML = movie.actor.map(actor => 
                        `<a href="index.html?search=${encodeURIComponent(actor)}" class="actor-tag">${actor}</a>`
                    ).join('');
                }

                const directors = (movie.director && movie.director.length > 0 && movie.director[0] !== "") ? movie.director.join(', ') : 'ƒêang c·∫≠p nh·∫≠t';
                
                let categoriesHTML = 'ƒêang c·∫≠p nh·∫≠t';
                if (movie.category && movie.category.length > 0) {
                    categoriesHTML = movie.category.map(cat => 
                        `<a href="index.html?search=${encodeURIComponent(cat.name)}" class="actor-tag" style="background: rgba(229, 9, 20, 0.2); border: 1px solid #e50914;">${cat.name}</a>`
                    ).join('');
                }

                const isSaved = savedMovies[slug] ? true : false;
                const btnText = isSaved ? '‚ùå B·ªè L∆∞u' : '‚ù§Ô∏è L∆∞u Phim';
                const btnClass = isSaved ? 'save-btn saved' : 'save-btn';

                container.innerHTML = `
                    <div class="detail-container">
                        <div class="detail-poster">
                            <img src="${posterUrl}" alt="${movie.name}" class="detail-poster-img" onerror="this.src='https://via.placeholder.com/300x450?text=Loi+Anh'">
                            <button id="saveMovieBtn" class="${btnClass}">${btnText}</button>
                        </div>
                        <div class="detail-info">
                            <h1 style="margin-bottom: 5px;">${movie.name}</h1>
                            <p style="color: #bbb; margin-top: 0;">${movie.origin_name} (${movie.year || 'N/A'})</p>
                            
                            <div class="meta-info">
                                <div style="margin-bottom: 8px;"><span>üé¨ ƒê·∫°o di·ªÖn:</span> <strong>${directors}</strong></div>
                                <div style="margin-bottom: 8px; display: flex; align-items: flex-start;">
                                    <span>üé≠ Di·ªÖn vi√™n:</span> 
                                    <div style="flex: 1;">${actorsHTML}</div>
                                </div>
                                <div style="display: flex; align-items: flex-start;">
                                    <span>üè∑Ô∏è Th·ªÉ lo·∫°i:</span> 
                                    <div style="flex: 1;">${categoriesHTML}</div>
                                </div>
                            </div>

                            <div class="movie-content">
                                <h3 style="margin-bottom: 5px;">N·ªôi dung:</h3>
                                <p style="margin-top: 0; line-height: 1.5; color: #ddd;">${contentText}</p>
                            </div>
                            
                            <h3 style="margin-bottom: 10px;">Danh s√°ch t·∫≠p:</h3>
                            <div class="episodes-list" id="epList"></div>
                        </div>
                    </div>
                `;

                // X·ª¨ L√ù N√öT L∆ØU
                document.getElementById('saveMovieBtn').addEventListener('click', function() {
                    if (savedMovies[slug]) {
                        delete savedMovies[slug];
                        this.textContent = '‚ù§Ô∏è L∆∞u Phim';
                        this.className = 'save-btn';
                    } else {
                        savedMovies[slug] = { name: movie.name, thumb: posterUrl, year: movie.year };
                        this.textContent = '‚ùå B·ªè L∆∞u';
                        this.className = 'save-btn saved';
                    }
                    localStorage.setItem('savedMovies', JSON.stringify(savedMovies));
                });

                // X·ª¨ L√ù DANH S√ÅCH T·∫¨P
                const epList = document.getElementById('epList');
                if (episodes.length > 0) {
                    const serverData = episodes[0].server_data;
                    serverData.forEach(ep => {
                        const btn = document.createElement('a');
                        btn.classList.add('ep-btn');
                        btn.textContent = ep.name.replace('T·∫≠p ', '');
                        btn.href = `watch.html?url=${encodeURIComponent(ep.link_m3u8)}&slug=${slug}`;
                        
                        btn.addEventListener('click', function() {
                            let history = JSON.parse(localStorage.getItem('watchHistory')) || {};
                            if (history[slug]) delete history[slug]; 
                            history[slug] = { name: movie.name, thumb: posterUrl, year: movie.year, epName: ep.name, time: Date.now() };
                            localStorage.setItem('watchHistory', JSON.stringify(history));
                        });
                        epList.appendChild(btn);
                    });
                } else {
                    epList.innerHTML = '<p>Phim ƒëang c·∫≠p nh·∫≠t t·∫≠p...</p>';
                }
            } catch (error) {
                container.innerHTML = '<h2>M·∫•t k·∫øt n·ªëi m·∫°ng ho·∫∑c l·ªói server.</h2>';
            }
        }
        loadDetail();
    </script>
</body>
</html>