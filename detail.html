<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi ti·∫øt phim</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .header-links a { color: white; margin-left: 20px; font-weight: bold; text-decoration: none;}
        .save-btn { background-color: #e50914; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 20px; font-weight: bold; width: 100%; transition: 0.2s;}
        .save-btn.saved { background-color: #333; }
        .save-btn:hover { background-color: #ff0a16; }
        
        .meta-info { margin: 15px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 14px; line-height: 1.6; border: 1px solid rgba(255,255,255,0.1);}
        .meta-info span { color: #aaa; display: inline-block; width: 85px;}
        .meta-info strong { color: #fff; font-weight: 500;}
        
        .actor-tag {
            display: inline-block; background: rgba(255,255,255,0.15); color: #fff;
            padding: 4px 10px; border-radius: 15px; margin: 3px 3px 3px 0;
            text-decoration: none; font-size: 13px; transition: 0.2s;
        }
        .actor-tag:hover { background: #e50914; color: white; transform: scale(1.05);}
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="logo">NETFLIX FAKE</a>
        <div class="header-links"><a href="tu-phim.html">‚ù§Ô∏è T·ªß Phim</a></div>
    </header>

    <div class="container" id="detailContainer">
        <div class="loader" id="loader"></div>
    </div>

    <script>
        const container = document.getElementById('detailContainer');
        const loader = document.getElementById('loader');
        const urlParams = new URLSearchParams(window.location.search);
        const slug = urlParams.get('slug');

        let savedMovies = JSON.parse(localStorage.getItem('savedMovies')) || {};

        async function loadDetail() {
            if (!slug) return container.innerHTML = '<h2>Kh√¥ng t√¨m th·∫•y m√£ phim!</h2>';
            loader.style.display = 'block';
            
            try {
                // ================= G·ªåI SONG SONG 3 API C√ôNG L√öC =================
                const [resOphim, resKK, resNguonC] = await Promise.all([
                    fetch(`https://ophim1.com/v1/api/phim/${slug}`).catch(() => null),
                    fetch(`https://phimapi.com/phim/${slug}`).catch(() => null),
                    fetch(`https://phim.nguonc.com/api/film/${slug}`).catch(() => null)
                ]);

                // ƒê·ªçc d·ªØ li·ªáu JSON an to√†n (B·ªè qua l·ªói n·∫øu server s·∫≠p)
                const dataOphim = resOphim ? await resOphim.json().catch(()=>null) : null;
                const dataKK = resKK ? await resKK.json().catch(()=>null) : null;
                const dataNguonC = resNguonC ? await resNguonC.json().catch(()=>null) : null;

                loader.style.display = 'none';

                // ∆Øu ti√™n l·∫•y th√¥ng tin poster/n·ªôi dung t·ª´ ngu·ªìn n√†o g·ªçi th√†nh c√¥ng tr∆∞·ªõc
                let movie = null;
                let imgDomain = 'https://img.ophim.live';
                
                const validData = [dataOphim, dataKK, dataNguonC].find(d => d && (d.status === 'success' || d.status === true));
                
                if (validData) {
                    movie = validData.movie || validData.item || validData.data?.item;
                    imgDomain = validData.data?.APP_DOMAIN_CDN_IMAGE || validData.APP_DOMAIN_CDN_IMAGE || imgDomain;
                }

                if (!movie) return container.innerHTML = '<h2>Phim ch∆∞a ƒë∆∞·ª£c c·∫≠p nh·∫≠t tr√™n c·∫£ 3 Server! Vui l√≤ng th·ª≠ l·∫°i sau.</h2>';

                let posterUrl = movie.thumb_url || movie.poster_url;
                if (posterUrl && !posterUrl.startsWith('http')) posterUrl = `${imgDomain}/uploads/movies/${posterUrl}`;

                const contentText = movie.content ? movie.content.replace(/(<([^>]+)>)/gi, "") : 'ƒêang c·∫≠p nh·∫≠t...';
                
                let actorsHTML = '<span style="color:#aaa;">ƒêang c·∫≠p nh·∫≠t</span>';
                if (movie.actor && movie.actor.length > 0 && movie.actor[0] !== "") {
                    actorsHTML = movie.actor.map(actor => `<a href="index.html?search=${encodeURIComponent(actor)}" class="actor-tag">${actor}</a>`).join('');
                }

                const directors = (movie.director && movie.director.length > 0 && movie.director[0] !== "") ? movie.director.join(', ') : 'ƒêang c·∫≠p nh·∫≠t';
                
                let categoriesHTML = 'ƒêang c·∫≠p nh·∫≠t';
                if (movie.category && movie.category.length > 0) {
                    categoriesHTML = movie.category.map(cat => `<a href="index.html?search=${encodeURIComponent(cat.name)}" class="actor-tag" style="background: rgba(229, 9, 20, 0.2); border: 1px solid #e50914;">${cat.name}</a>`).join('');
                }

                const isSaved = savedMovies[slug] ? true : false;
                const btnText = isSaved ? '‚ùå B·ªè L∆∞u' : '‚ù§Ô∏è L∆∞u Phim';
                const btnClass = isSaved ? 'save-btn saved' : 'save-btn';

                container.innerHTML = `
                    <div class="detail-container">
                        <div class="detail-poster">
                            <img src="${posterUrl}" alt="${movie.name}" class="detail-poster-img" onerror="this.src='https://via.placeholder.com/300x450?text=Loi+Anh'">
                            <button id="saveMovieBtn" class="${btnClass}">${btnText}</button>
                        </div>
                        <div class="detail-info">
                            <h1 style="margin-bottom: 5px;">${movie.name}</h1>
                            <p style="color: #bbb; margin-top: 0;">${movie.origin_name} (${movie.year || 'N/A'})</p>
                            
                            <div class="meta-info">
                                <div style="margin-bottom: 8px;"><span>üé¨ ƒê·∫°o di·ªÖn:</span> <strong>${directors}</strong></div>
                                <div style="margin-bottom: 8px; display: flex; align-items: flex-start;">
                                    <span>üé≠ Di·ªÖn vi√™n:</span> <div style="flex: 1;">${actorsHTML}</div>
                                </div>
                                <div style="display: flex; align-items: flex-start;">
                                    <span>üè∑Ô∏è Th·ªÉ lo·∫°i:</span> <div style="flex: 1;">${categoriesHTML}</div>
                                </div>
                            </div>

                            <div class="movie-content">
                                <h3 style="margin-bottom: 5px;">N·ªôi dung:</h3>
                                <p style="margin-top: 0; line-height: 1.5; color: #ddd;">${contentText}</p>
                            </div>
                            
                            <h3 style="margin-bottom: 10px;">Danh s√°ch t·∫≠p:</h3>
                            <div class="episodes-list" id="epList" style="flex-direction: column;"></div>
                        </div>
                    </div>
                `;

                // X·ª¨ L√ù N√öT L∆ØU PHIM
                document.getElementById('saveMovieBtn').addEventListener('click', function() {
                    if (savedMovies[slug]) {
                        delete savedMovies[slug];
                        this.textContent = '‚ù§Ô∏è L∆∞u Phim';
                        this.className = 'save-btn';
                    } else {
                        savedMovies[slug] = { name: movie.name, thumb: posterUrl, year: movie.year };
                        this.textContent = '‚ùå B·ªè L∆∞u';
                        this.className = 'save-btn saved';
                    }
                    localStorage.setItem('savedMovies', JSON.stringify(savedMovies));
                });

                // ================= T·ªîNG H·ª¢P DANH S√ÅCH T·∫¨P T·ª™ 3 NGU·ªíN =================
                let combinedEpisodes = [];
                
                // 1. D·ªØ li·ªáu t·ª´ Ophim
                if (dataOphim) {
                    let epsOphim = dataOphim.data?.item?.episodes || dataOphim.episodes || [];
                    epsOphim.forEach(sv => { 
                        if(sv.server_data && sv.server_data.length > 0) {
                            sv.server_name += " (Ophim)"; 
                            combinedEpisodes.push(sv); 
                        }
                    });
                }
                
                // 2. D·ªØ li·ªáu t·ª´ KKPhim (Th∆∞·ªùng c√≥ Thuy·∫øt Minh c·ª±c t·ªët)
                if (dataKK) {
                    let epsKK = dataKK.episodes || dataKK.movie?.episodes || dataKK.data?.item?.episodes || [];
                    epsKK.forEach(sv => { 
                        if(sv.server_data && sv.server_data.length > 0) {
                            sv.server_name += " (KKPhim)"; 
                            combinedEpisodes.push(sv); 
                        }
                    });
                }

                // 3. D·ªØ li·ªáu t·ª´ NguonC (Ngu·ªìn backup d·ª± ph√≤ng)
                if (dataNguonC) {
                    let epsNguonC = dataNguonC.episodes || dataNguonC.movie?.episodes || dataNguonC.item?.episodes || dataNguonC.data?.item?.episodes || [];
                    epsNguonC.forEach(sv => { 
                        if(sv.server_data && sv.server_data.length > 0) {
                            sv.server_name += " (NguonC)"; 
                            combinedEpisodes.push(sv); 
                        }
                    });
                }

                // IN RA M√ÄN H√åNH
                const epList = document.getElementById('epList');
                epList.innerHTML = ''; 

                if (combinedEpisodes.length > 0) {
                    combinedEpisodes.forEach((server) => {
                        const serverTitle = document.createElement('h4');
                        serverTitle.style.cssText = "width: 100%; margin-top: 15px; margin-bottom: 10px; color: #e50914; font-size: 16px;";
                        serverTitle.textContent = `‚ñ∂ ${server.server_name}`;
                        epList.appendChild(serverTitle);
                        
                        const serverDiv = document.createElement('div');
                        serverDiv.style.cssText = "display: flex; flex-wrap: wrap; gap: 10px; width: 100%;";
                        
                        server.server_data.forEach(ep => {
                            const btn = document.createElement('a');
                            btn.classList.add('ep-btn');
                            btn.textContent = ep.name.replace('T·∫≠p ', '');
                            btn.href = `watch.html?url=${encodeURIComponent(ep.link_m3u8)}&slug=${slug}`;
                            
                            btn.addEventListener('click', function() {
                                let history = JSON.parse(localStorage.getItem('watchHistory')) || {};
                                if (history[slug]) delete history[slug]; 
                                // L∆∞u L·ªãch S·ª≠ Nh·ªõ K√®m T√™n Server (V√≠ d·ª•: T·∫≠p 1 Thuy·∫øt Minh KKPhim)
                                history[slug] = { name: movie.name, thumb: posterUrl, year: movie.year, epName: `${ep.name} ${server.server_name}`, time: Date.now() };
                                localStorage.setItem('watchHistory', JSON.stringify(history));
                            });
                            serverDiv.appendChild(btn);
                        });
                        epList.appendChild(serverDiv);
                    });
                } else {
                    epList.innerHTML = '<p style="color:red;">Phim ƒëang ƒë∆∞·ª£c c√°c Server c·∫≠p nh·∫≠t t·∫≠p...</p>';
                }
            } catch (error) {
                console.error(error);
                container.innerHTML = '<h2>L·ªói t·∫£i d·ªØ li·ªáu. B·∫°n h√£y t·∫£i l·∫°i trang nh√©!</h2>';
            }
        }
        
        loadDetail();
    </script>
</body>
</html>