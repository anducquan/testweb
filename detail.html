<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết phim</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .header-links a { color: white; margin-left: 20px; font-weight: bold; text-decoration: none;}
        .save-btn { background-color: #e50914; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 20px; font-weight: bold;}
        .save-btn.saved { background-color: #333; }
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="logo">NETFLIX FAKE</a>
        <div class="header-links">
            <a href="tu-phim.html">❤️ Tủ Phim</a>
        </div>
    </header>

    <div class="container" id="detailContainer">
        <div class="loader" id="loader"></div>
    </div>

    <script>
        const API_DETAIL = 'https://ophim1.com/v1/api/phim/';
        
        const container = document.getElementById('detailContainer');
        const loader = document.getElementById('loader');
        const urlParams = new URLSearchParams(window.location.search);
        const slug = urlParams.get('slug');

        let savedMovies = JSON.parse(localStorage.getItem('savedMovies')) || {};

        async function loadDetail() {
            if (!slug) return container.innerHTML = '<h2>Không tìm thấy mã phim!</h2>';
            
            loader.style.display = 'block';
            
            try {
                const response = await fetch(API_DETAIL + slug);
                const data = await response.json();
                loader.style.display = 'none';

                if (data.status !== 'success' && data.status !== true) {
                    return container.innerHTML = '<h2>Phim không tồn tại hoặc lỗi máy chủ nguồn.</h2>';
                }

                const movie = (data.data && data.data.item) ? data.data.item : data.movie;
                if (!movie) {
                    return container.innerHTML = '<h2>Lỗi cấu trúc dữ liệu phim.</h2>';
                }

                const episodes = (data.data && data.data.item && data.data.item.episodes) ? data.data.item.episodes : (data.episodes || movie.episodes || []);

                let imgDomain = (data.data && data.data.APP_DOMAIN_CDN_IMAGE) ? data.data.APP_DOMAIN_CDN_IMAGE : 'https://img.ophim.live';
                let posterUrl = movie.thumb_url || movie.poster_url;
                if (posterUrl && !posterUrl.startsWith('http')) {
                    posterUrl = `${imgDomain}/uploads/movies/${posterUrl}`;
                }

                const contentText = movie.content ? movie.content.replace(/(<([^>]+)>)/gi, "") : 'Đang cập nhật...';
                
                const isSaved = savedMovies[slug] ? true : false;
                const btnText = isSaved ? '❌ Bỏ Lưu' : '❤️ Lưu Phim';
                const btnClass = isSaved ? 'save-btn saved' : 'save-btn';

                container.innerHTML = `
                    <div class="detail-container">
                        <div class="detail-poster">
                            <img src="${posterUrl}" alt="${movie.name}" class="detail-poster-img" onerror="this.src='https://via.placeholder.com/300x450?text=Loi+Anh'">
                            <br>
                            <button id="saveMovieBtn" class="${btnClass}">${btnText}</button>
                        </div>
                        <div class="detail-info">
                            <h1>${movie.name}</h1>
                            <p style="color: #bbb;">${movie.origin_name} (${movie.year || 'Đang cập nhật'})</p>
                            <div class="movie-content"><h3>Nội dung:</h3><p>${contentText}</p></div>
                            <h3>Danh sách tập:</h3>
                            <div class="episodes-list" id="epList"></div>
                        </div>
                    </div>
                `;

                // XỬ LÝ NÚT LƯU PHIM VÀO TỦ
                document.getElementById('saveMovieBtn').addEventListener('click', function() {
                    if (savedMovies[slug]) {
                        delete savedMovies[slug];
                        this.textContent = '❤️ Lưu Phim';
                        this.className = 'save-btn';
                    } else {
                        savedMovies[slug] = { name: movie.name, thumb: posterUrl, year: movie.year };
                        this.textContent = '❌ Bỏ Lưu';
                        this.className = 'save-btn saved';
                    }
                    localStorage.setItem('savedMovies', JSON.stringify(savedMovies));
                });

                // XỬ LÝ DANH SÁCH TẬP VÀ LƯU LỊCH SỬ
                const epList = document.getElementById('epList');
                if (episodes.length > 0) {
                    const serverData = episodes[0].server_data;
                    serverData.forEach(ep => {
                        const linkM3u8 = ep.link_m3u8;
                        const btn = document.createElement('a');
                        btn.classList.add('ep-btn');
                        btn.textContent = ep.name.replace('Tập ', '');
                        btn.href = `watch.html?url=${encodeURIComponent(linkM3u8)}`;
                        
                        // Lắng nghe sự kiện click để lưu lịch sử xem
                        btn.addEventListener('click', function() {
                            let history = JSON.parse(localStorage.getItem('watchHistory')) || {};
                            if (history[slug]) delete history[slug]; 
                            
                            history[slug] = {
                                name: movie.name,
                                thumb: posterUrl,
                                year: movie.year,
                                epName: ep.name, 
                                time: Date.now() 
                            };
                            localStorage.setItem('watchHistory', JSON.stringify(history));
                        });

                        epList.appendChild(btn);
                    });
                } else {
                    epList.innerHTML = '<p>Phim đang cập nhật tập...</p>';
                }

            } catch (error) {
                console.error("Chi tiết lỗi:", error);
                container.innerHTML = '<h2>Mất kết nối mạng hoặc lỗi server OPhim. Vui lòng tải lại trang.</h2>';
            }
        }
        
        loadDetail();
    </script>
</body>
</html>