<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·ªß Phim C·ªßa T√¥i</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .header-links a { color: white; margin-left: 20px; font-weight: bold; }
        .sync-box { background: #333; padding: 20px; border-radius: 10px; margin-bottom: 30px; }
        .sync-box input { padding: 10px; width: 60%; border-radius: 5px; border: none; outline: none; margin-right: 10px;}
        .sync-btn { padding: 10px 20px; background: #e50914; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;}
        
        .movie-card { position: relative; }
        .delete-btn {
            position: absolute; top: 5px; left: 5px; background: rgba(229, 9, 20, 0.9);
            color: white; border: none; border-radius: 50%; width: 25px; height: 25px;
            font-size: 12px; font-weight: bold; cursor: pointer; z-index: 20; display: flex;
            align-items: center; justify-content: center; transition: 0.2s;
        }
        .delete-btn:hover { transform: scale(1.1); background: #ff0a16; }
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="logo">NETFLIX FAKE</a>
        <div class="header-links">
            <a href="index.html">üè† Trang ch·ªß</a>
        </div>
    </header>

    <div class="container">
        <h2 class="section-title">Phim ƒê√£ L∆∞u</h2>
        
        <div class="sync-box">
            <h3>ƒê·ªìng b·ªô thi·∫øt b·ªã (Si√™u t·ªëc)</h3>
            <p style="font-size: 14px; color: #bbb;">B·∫•m "L·∫•y M√£" ƒë·ªÉ t·∫°o m√£ si√™u ng·∫Øn. Sang m√°y kh√°c d√°n m√£ n√†y v√†o r·ªìi b·∫•m "Nh·∫≠p M√£" ƒë·ªÉ kh√¥i ph·ª•c t·ªß phim.</p>
            <input type="text" id="syncCodeInput" placeholder="D√°n m√£ ƒë·ªìng b·ªô v√†o ƒë√¢y...">
            <button class="sync-btn" onclick="exportCode()">L·∫•y M√£ C·ªßa T√¥i</button>
            <button class="sync-btn" style="background: #28a745;" onclick="importCode()">Nh·∫≠p M√£</button>
        </div>

        <div class="movie-grid" id="savedGrid"></div>
    </div>

    <script>
        const savedGrid = document.getElementById('savedGrid');
        const syncCodeInput = document.getElementById('syncCodeInput');
        
        function loadSavedMovies() {
            const savedMovies = JSON.parse(localStorage.getItem('savedMovies')) || {};
            savedGrid.innerHTML = '';
            
            const slugs = Object.keys(savedMovies);
            if (slugs.length === 0) {
                savedGrid.innerHTML = '<p>B·∫°n ch∆∞a l∆∞u b·ªô phim n√†o. H√£y ra Trang ch·ªß v√† th·∫£ tim v√†i b·ªô phim nh√©!</p>';
                return;
            }

            slugs.forEach(slug => {
                const movie = savedMovies[slug];
                const card = document.createElement('div');
                card.classList.add('movie-card');
                card.innerHTML = `
                    <button class="delete-btn" onclick="deleteMovie('${slug}')" title="X√≥a kh·ªèi t·ªß phim">‚úï</button>
                    <a href="detail.html?slug=${slug}" style="text-decoration: none; color: inherit; display: block;">
                        <img src="${movie.thumb}" alt="${movie.name}" class="movie-poster" loading="lazy">
                        <div class="movie-info">
                            <div class="movie-title">${movie.name}</div>
                            <div class="movie-year">${movie.year || ''}</div>
                        </div>
                    </a>
                `;
                savedGrid.appendChild(card);
            });
        }

        function deleteMovie(slug) {
            if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a phim n√†y kh·ªèi T·ªß Phim?')) {
                let savedMovies = JSON.parse(localStorage.getItem('savedMovies')) || {};
                delete savedMovies[slug]; 
                localStorage.setItem('savedMovies', JSON.stringify(savedMovies));
                loadSavedMovies(); 
            }
        }

        // ================= ƒê√É S·ª¨A: XU·∫§T M√É SI√äU NG·∫ÆN =================
        function exportCode() {
            const savedMovies = JSON.parse(localStorage.getItem('savedMovies')) || {};
            const slugs = Object.keys(savedMovies); // Ch·ªâ l·∫•y ID (slug)
            
            if (slugs.length === 0) return alert("T·ªß phim tr·ªëng! H√£y l∆∞u v√†i b·ªô phim tr∆∞·ªõc.");

            // Ch·ªâ gh√©p c√°c ID l·∫°i v·ªõi nhau r·ªìi n√©n
            const code = btoa(slugs.join(',')); 
            syncCodeInput.value = code;

            // T·ª± ƒë·ªông Copy v√†o b·ªô nh·ªõ t·∫°m c·ªßa ƒëi·ªán tho·∫°i/m√°y t√≠nh
            try {
                navigator.clipboard.writeText(code);
                alert("ƒê√£ t·∫°o m√£ NG·∫ÆN G·ªåN th√†nh c√¥ng!\n\nƒê√£ T·ª∞ ƒê·ªòNG COPY m√£, b·∫°n ch·ªâ c·∫ßn g·ª≠i qua Zalo/Mess v√† d√°n sang m√°y kh√°c nh√©.");
            } catch(e) {
                alert("ƒê√£ t·∫°o m√£! Vui l√≤ng b√¥i ƒëen v√† copy ƒëo·∫°n m√£ trong √¥.");
            }
        }

        // ================= ƒê√É S·ª¨A: NH·∫¨P M√É TH√îNG MINH =================
        async function importCode() {
            const code = syncCodeInput.value.trim();
            if (!code) return alert("Vui l√≤ng d√°n m√£ ƒë·ªìng b·ªô v√†o √¥ tr·ªëng!");
            
            try {
                // Gi·∫£i n√©n ra danh s√°ch ID phim
                const slugsStr = atob(code);
                const slugs = slugsStr.split(',');
                
                syncCodeInput.value = 'ƒêang k√©o d·ªØ li·ªáu phim v·ªÅ m√°y... Vui l√≤ng ƒë·ª£i!';
                let currentSaved = JSON.parse(localStorage.getItem('savedMovies')) || {};

                // T·ª± ƒë·ªông g·ªçi API l·∫•y l·∫°i ·∫£nh v√† t√™n phim cho t·ª´ng ID
                for(let slug of slugs) {
                    if(slug && !currentSaved[slug]) {
                        try {
                            const res = await fetch(`https://ophim1.com/v1/api/phim/${slug}`);
                            const data = await res.json();
                            if(data.status === 'success' && data.data && data.data.item) {
                                const movie = data.data.item;
                                const imgDomain = data.data.APP_DOMAIN_CDN_IMAGE || 'https://img.ophim.live';
                                let posterUrl = movie.thumb_url || movie.poster_url;
                                if (posterUrl && !posterUrl.startsWith('http')) {
                                    posterUrl = `${imgDomain}/uploads/movies/${posterUrl}`;
                                }
                                currentSaved[slug] = { name: movie.name, thumb: posterUrl, year: movie.year };
                            }
                        } catch (err) {
                            console.log("L·ªói t·∫£i th√¥ng tin phim: ", slug);
                        }
                    }
                }

                // C·∫•t v√†o b·ªô nh·ªõ v√† load l·∫°i giao di·ªán
                localStorage.setItem('savedMovies', JSON.stringify(currentSaved));
                loadSavedMovies();
                syncCodeInput.value = '';
                alert("ƒê·ªìng b·ªô th√†nh c√¥ng! C√°c phim m·ªõi ƒë√£ ƒë∆∞·ª£c th√™m v√†o t·ªß.");

            } catch (e) {
                alert("M√£ kh√¥ng h·ª£p l·ªá! Vui l√≤ng ki·ªÉm tra l·∫°i.");
                syncCodeInput.value = '';
            }
        }

        loadSavedMovies();
    </script>
</body>
</html>