<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·ªß Phim C·ªßa T√¥i</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        .header-links a { color: white; margin-left: 20px; font-weight: bold; text-decoration: none;}
        .sync-box { background: #222; padding: 20px; border-radius: 10px; margin-bottom: 30px; border: 1px solid #333; text-align: center;}
        .sync-box h3 { margin-top: 0; color: #fff; }
        .sync-btn-group { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 15px;}
        .sync-btn { padding: 10px 20px; background: #e50914; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s;}
        .sync-btn:hover { background: #ff0a16; }
        .sync-btn.qr-btn { background: #fff; color: #000; }
        .sync-btn.qr-btn:hover { background: #ddd; }
        
        /* FIX CƒÇN GI·ªÆA HO√ÄN H·∫¢O CHO M√É QR */
        #qrcode-container { display: none; margin: 20px auto 0; background: white; padding: 20px; border-radius: 10px; max-width: 250px; text-align: center; }
        #qrcode { display: flex; justify-content: center; margin-top: 10px; }
        #qrcode img { margin: 0 auto; } /* √âp ·∫£nh QR v√†o t√¢m */
        
        .movie-card { position: relative; text-align: left; }
        .delete-btn { position: absolute; top: 5px; left: 5px; background: rgba(229, 9, 20, 0.9); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; font-size: 12px; font-weight: bold; cursor: pointer; z-index: 20; display: flex; align-items: center; justify-content: center;}
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="logo">NETFLIX FAKE</a>
        <div class="header-links"><a href="index.html">üè† Trang ch·ªß</a></div>
    </header>

    <div class="container">
        <div class="sync-box">
            <h3>üîÑ Chia S·∫ª & ƒê·ªìng B·ªô Th√¥ng Minh</h3>
            <p style="font-size: 14px; color: #bbb; margin-top: 0;">Truy·ªÅn T·ªß Phim v√† L·ªãch S·ª≠ ƒëang xem sang m√°y kh√°c trong 1 n·ªët nh·∫°c!</p>
            
            <div class="sync-btn-group">
                <button class="sync-btn" onclick="copyMagicLink()">üîó Copy Link ƒê·ªìng B·ªô </button>
                <button class="sync-btn qr-btn" onclick="showQRCode()">üì± Hi·ªán M√£ QR (D√πng ƒêT Qu√©t)</button>
            </div>

            <div id="qrcode-container" style="display: none;">
                <p style="color: black; font-weight: bold; margin-top: 0;">M·ªü Camera ƒëi·ªán tho·∫°i qu√©t m√£ n√†y:</p>
                <div id="qrcode"></div>
            </div>
        </div>

        <h2 class="section-title">‚ù§Ô∏è Phim ƒê√£ L∆∞u</h2>
        <div class="movie-grid" id="savedGrid"></div>
    </div>

    <script>
        const savedGrid = document.getElementById('savedGrid');
        
        // ================= HI·ªÇN TH·ªä T·ª¶ PHIM =================
        function loadSavedMovies() {
            const savedMovies = JSON.parse(localStorage.getItem('savedMovies')) || {};
            savedGrid.innerHTML = '';
            const slugs = Object.keys(savedMovies);
            if (slugs.length === 0) return savedGrid.innerHTML = '<p style="color: #aaa;">T·ªß phim tr·ªëng.</p>';

            slugs.reverse().forEach(slug => {
                const movie = savedMovies[slug];
                savedGrid.innerHTML += `
                    <div class="movie-card">
                        <button class="delete-btn" onclick="deleteMovie('${slug}')">‚úï</button>
                        <a href="detail.html?slug=${slug}" style="text-decoration: none; color: inherit; display: block;">
                            <img src="${movie.thumb}" class="movie-poster" onerror="this.src='https://via.placeholder.com/160x240?text=No+Image'">
                            <div class="movie-info">
                                <div class="movie-title">${movie.name}</div>
                            </div>
                        </a>
                    </div>
                `;
            });
        }

        window.deleteMovie = function(slug) {
            if(confirm('X√≥a phim n√†y kh·ªèi T·ªß Phim?')) {
                let saved = JSON.parse(localStorage.getItem('savedMovies')) || {};
                delete saved[slug]; localStorage.setItem('savedMovies', JSON.stringify(saved));
                loadSavedMovies(); 
            }
        };

        // ================= T·∫†O M√É D·ªÆ LI·ªÜU ƒê·ªíNG B·ªò =================
        function generateSyncData() {
            const saved = JSON.parse(localStorage.getItem('savedMovies')) || {};
            const history = JSON.parse(localStorage.getItem('watchHistory')) || {};
            const progress = JSON.parse(localStorage.getItem('videoProgress')) || {};

            const sSlugs = Object.keys(saved).join(',');
            const hItems = Object.keys(history).map(slug => {
                let ep = history[slug].epName ? history[slug].epName.replace('T·∫≠p ', '').replace('Full', 'F').trim() : '';
                return `${slug}:${ep}:${progress[slug] || 0}`;
            }).join(',');

            const code = `${sSlugs}*${hItems}`;
            return code === '*' ? null : code;
        }

        function getMagicLink() {
            const data = generateSyncData();
            if (!data) return null;
            // Tr·∫£ v·ªÅ d·∫°ng nguy√™n th·ªßy d·ªÖ ƒë·ªçc
            return window.location.origin + window.location.pathname + "?sync=" + encodeURIComponent(data);
        }

        // ================= X·ª¨ L√ù N√öT B·∫§M =================
        window.copyMagicLink = function() {
            const link = getMagicLink();
            if (!link) return alert("B·∫°n ch∆∞a c√≥ phim n√†o ƒë·ªÉ chia s·∫ª!");
            
            navigator.clipboard.writeText(link).then(() => {
                alert("ƒê√£ copy Link ƒê·ªìng B·ªô!");
            }).catch(() => prompt("Copy th·ªß c√¥ng ƒë∆∞·ªùng link n√†y:", link));
        };

        let qrcodeObj = null;
        window.showQRCode = function() {
            const link = getMagicLink();
            if (!link) return alert("B·∫°n ch∆∞a c√≥ phim n√†o ƒë·ªÉ ƒë·ªìng b·ªô!");
            
            const qrContainer = document.getElementById('qrcode-container');
            qrContainer.style.display = 'block';
            
            if (qrcodeObj) {
                qrcodeObj.clear();
                qrcodeObj.makeCode(link);
            } else {
                qrcodeObj = new QRCode(document.getElementById("qrcode"), {
                    text: link,
                    width: 200,
                    height: 200,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.L
                });
            }
        };

        // ================= T·ª∞ ƒê·ªòNG ƒê·ªíNG B·ªò (NH·∫¨N LINK) =================
        async function autoImportFromLink() {
            const urlParams = new URLSearchParams(window.location.search);
            const syncData = urlParams.get('sync');
            
            if (syncData) {
                try {
                    const parts = syncData.split('*');
                    const savedSlugs = parts[0] ? parts[0].split(',') : [];
                    const histItems = parts[1] ? parts[1].split(',') : [];
                    
                    document.body.insertAdjacentHTML('afterbegin', '<div id="syncOverlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);color:white;z-index:9999;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:bold;">ƒêang t·∫£i d·ªØ li·ªáu ƒë·ªìng b·ªô...</div>');
                    
                    let currentSaved = JSON.parse(localStorage.getItem('savedMovies')) || {};
                    let currentHist = JSON.parse(localStorage.getItem('watchHistory')) || {};
                    let currentProg = JSON.parse(localStorage.getItem('videoProgress')) || {};

                    async function getMovieInfo(slug) {
                        try {
                            const res = await fetch(`https://ophim1.com/v1/api/phim/${slug}`);
                            const data = await res.json();
                            if(data.status === 'success' && data.data && data.data.item) {
                                const m = data.data.item;
                                const imgDomain = data.data.APP_DOMAIN_CDN_IMAGE || 'https://img.ophim.live';
                                let posterUrl = m.thumb_url || m.poster_url;
                                if (posterUrl && !posterUrl.startsWith('http')) posterUrl = `${imgDomain}/uploads/movies/${posterUrl}`;
                                return { name: m.name, thumb: posterUrl, year: m.year };
                            }
                        } catch(e) {} return null;
                    }

                    for(let slug of savedSlugs) {
                        if(slug && !currentSaved[slug]) {
                            const info = await getMovieInfo(slug);
                            if(info) currentSaved[slug] = info;
                        }
                    }

                    for(let item of histItems) {
                        if(item) {
                            const [slug, ep, p] = item.split(':');
                            if(slug) {
                                const info = currentSaved[slug] || await getMovieInfo(slug);
                                if(info) {
                                    currentHist[slug] = { name: info.name, thumb: info.thumb, year: info.year, epName: ep === 'F' ? 'Full' : (ep ? 'T·∫≠p ' + ep : 'T·∫≠p ?'), time: Date.now() };
                                    if (parseInt(p) > 0) currentProg[slug] = parseInt(p);
                                }
                            }
                        }
                    }

                    localStorage.setItem('savedMovies', JSON.stringify(currentSaved));
                    localStorage.setItem('watchHistory', JSON.stringify(currentHist));
                    localStorage.setItem('videoProgress', JSON.stringify(currentProg));
                    
                    alert("üéâ Kh√¥i ph·ª•c T·ªß phim & L·ªãch s·ª≠ th√†nh c√¥ng!");
                    window.history.replaceState({}, document.title, window.location.pathname);
                    document.getElementById('syncOverlay').remove();
                    loadSavedMovies();

                } catch (e) {
                    alert("Link ƒë·ªìng b·ªô kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ c≈©!");
                    document.getElementById('syncOverlay').remove();
                }
            }
        }

        loadSavedMovies();
        autoImportFromLink();
    </script>
</body>
</html>