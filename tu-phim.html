<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·ªß Phim C·ªßa T√¥i</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .header-links a { color: white; margin-left: 20px; font-weight: bold; }
        .sync-box { background: #333; padding: 20px; border-radius: 10px; margin-bottom: 30px; }
        .sync-box input { padding: 10px; width: 60%; border-radius: 5px; border: none; outline: none; margin-right: 10px;}
        .sync-btn { padding: 10px 20px; background: #e50914; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;}
        
        .movie-card { position: relative; }
        .delete-btn {
            position: absolute; top: 5px; left: 5px; background: rgba(229, 9, 20, 0.9);
            color: white; border: none; border-radius: 50%; width: 25px; height: 25px;
            font-size: 12px; font-weight: bold; cursor: pointer; z-index: 20; display: flex;
            align-items: center; justify-content: center; transition: 0.2s;
        }
        .delete-btn:hover { transform: scale(1.1); background: #ff0a16; }
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="logo">NETFLIX FAKE</a>
        <div class="header-links">
            <a href="index.html">üè† Trang ch·ªß</a>
        </div>
    </header>

    <div class="container">
        <h2 class="section-title">Phim ƒê√£ L∆∞u</h2>
        
        <div class="sync-box">
            <h3>ƒê·ªìng b·ªô K√©p (T·ªß Phim & L·ªãch S·ª≠)</h3>
            <p style="font-size: 14px; color: #bbb;">M√£ n√†y ch·ª©a c·∫£ danh s√°ch phim y√™u th√≠ch v√† phim b·∫°n ƒëang xem d·ªü. T·ª± ƒë·ªông Copy khi b·∫•m "L·∫•y M√£".</p>
            <input type="text" id="syncCodeInput" placeholder="D√°n m√£ ƒë·ªìng b·ªô v√†o ƒë√¢y...">
            <button class="sync-btn" onclick="exportCode()">L·∫•y M√£ C·ªßa T√¥i</button>
            <button class="sync-btn" style="background: #28a745;" onclick="importCode()">Nh·∫≠p M√£</button>
        </div>

        <div class="movie-grid" id="savedGrid"></div>
    </div>

    <script>
        const savedGrid = document.getElementById('savedGrid');
        const syncCodeInput = document.getElementById('syncCodeInput');
        
        function loadSavedMovies() {
            const savedMovies = JSON.parse(localStorage.getItem('savedMovies')) || {};
            savedGrid.innerHTML = '';
            
            const slugs = Object.keys(savedMovies);
            if (slugs.length === 0) {
                savedGrid.innerHTML = '<p>B·∫°n ch∆∞a l∆∞u b·ªô phim n√†o.</p>';
                return;
            }

            slugs.forEach(slug => {
                const movie = savedMovies[slug];
                const card = document.createElement('div');
                card.classList.add('movie-card');
                card.innerHTML = `
                    <button class="delete-btn" onclick="deleteMovie('${slug}')" title="X√≥a kh·ªèi t·ªß phim">‚úï</button>
                    <a href="detail.html?slug=${slug}" style="text-decoration: none; color: inherit; display: block;">
                        <img src="${movie.thumb}" alt="${movie.name}" class="movie-poster" loading="lazy" onerror="this.src='https://via.placeholder.com/160x240?text=No+Image'">
                        <div class="movie-info">
                            <div class="movie-title">${movie.name}</div>
                            <div class="movie-year">${movie.year || ''}</div>
                        </div>
                    </a>
                `;
                savedGrid.appendChild(card);
            });
        }

        function deleteMovie(slug) {
            if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a phim n√†y kh·ªèi T·ªß Phim?')) {
                let savedMovies = JSON.parse(localStorage.getItem('savedMovies')) || {};
                delete savedMovies[slug]; 
                localStorage.setItem('savedMovies', JSON.stringify(savedMovies));
                loadSavedMovies(); 
            }
        }

        // ================= XU·∫§T M√É ƒê·ªíNG B·ªò TO√ÄN DI·ªÜN =================
        function exportCode() {
            const saved = JSON.parse(localStorage.getItem('savedMovies')) || {};
            const history = JSON.parse(localStorage.getItem('watchHistory')) || {};
            const progress = JSON.parse(localStorage.getItem('videoProgress')) || {};

            // G·ªôp c·∫£ 3 lo·∫°i d·ªØ li·ªáu v√†o 1 g√≥i
            const exportData = {
                s: Object.keys(saved), // ID t·ªß phim
                h: history,            // L·ªãch s·ª≠ ƒëang xem
                p: progress            // S·ªë gi√¢y ƒëang xem c·ªßa t·ª´ng phim
            };

            if (exportData.s.length === 0 && Object.keys(exportData.h).length === 0) {
                return alert("T·ªß phim v√† L·ªãch s·ª≠ ƒë·ªÅu tr·ªëng, kh√¥ng c√≥ g√¨ ƒë·ªÉ xu·∫•t!");
            }

            // M√£ h√≥a d·ªØ li·ªáu (H·ªó tr·ª£ ti·∫øng Vi·ªát)
            const code = btoa(encodeURIComponent(JSON.stringify(exportData))); 
            syncCodeInput.value = code;

            try {
                navigator.clipboard.writeText(code);
                alert("ƒê√£ COPY m√£ ƒê·ªìng B·ªô!");
            } catch(e) {
                alert("ƒê√£ t·∫°o m√£! Vui l√≤ng b√¥i ƒëen v√† copy ƒëo·∫°n m√£ trong √¥.");
            }
        }

        // ================= NH·∫¨P M√É ƒê·ªíNG B·ªò TO√ÄN DI·ªÜN =================
        async function importCode() {
            const code = syncCodeInput.value.trim();
            if (!code) return alert("Vui l√≤ng d√°n m√£ ƒë·ªìng b·ªô v√†o √¥ tr·ªëng!");
            
            try {
                // Gi·∫£i m√£ d·ªØ li·ªáu
                const decoded = decodeURIComponent(atob(code));
                const importData = JSON.parse(decoded);
                
                syncCodeInput.value = 'ƒêang k√©o d·ªØ li·ªáu v·ªÅ m√°y... Vui l√≤ng ƒë·ª£i!';
                
                // 1. Ph·ª•c h·ªìi L·ªãch s·ª≠ (watchHistory) v√† S·ªë gi√¢y (videoProgress)
                if (importData.h) localStorage.setItem('watchHistory', JSON.stringify(importData.h));
                if (importData.p) localStorage.setItem('videoProgress', JSON.stringify(importData.p));

                // 2. Ph·ª•c h·ªìi T·ªß Phim (C·∫ßn g·ªçi API ƒë·ªÉ l·∫•y l·∫°i ·∫£nh)
                let currentSaved = JSON.parse(localStorage.getItem('savedMovies')) || {};
                
                if (importData.s && importData.s.length > 0) {
                    for(let slug of importData.s) {
                        if(slug && !currentSaved[slug]) {
                            try {
                                const res = await fetch(`https://ophim1.com/v1/api/phim/${slug}`);
                                const data = await res.json();
                                if(data.status === 'success' && data.data && data.data.item) {
                                    const movie = data.data.item;
                                    const imgDomain = data.data.APP_DOMAIN_CDN_IMAGE || 'https://img.ophim.live';
                                    let posterUrl = movie.thumb_url || movie.poster_url;
                                    if (posterUrl && !posterUrl.startsWith('http')) {
                                        posterUrl = `${imgDomain}/uploads/movies/${posterUrl}`;
                                    }
                                    currentSaved[slug] = { name: movie.name, thumb: posterUrl, year: movie.year };
                                }
                            } catch (err) { console.log("L·ªói: ", slug); }
                        }
                    }
                    localStorage.setItem('savedMovies', JSON.stringify(currentSaved));
                }

                loadSavedMovies();
                syncCodeInput.value = '';
                alert("ƒê·ªìng b·ªô th√†nh c√¥ng 100%!");

            } catch (e) {
                alert("M√£ kh√¥ng h·ª£p l·ªá! Vui l√≤ng ki·ªÉm tra l·∫°i.");
                syncCodeInput.value = '';
            }
        }

        loadSavedMovies();
    </script>
</body>
</html>