<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·ªß Phim C·ªßa T√¥i</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .header-links a { color: white; margin-left: 20px; font-weight: bold; text-decoration: none;}
        
        .sync-box { background: #222; padding: 20px; border-radius: 10px; margin-bottom: 30px; border: 1px solid #333;}
        .sync-box h3 { margin-top: 0; color: #fff; }
        .sync-box input { padding: 12px; width: calc(100% - 24px); border-radius: 5px; border: none; outline: none; margin-bottom: 10px; background: #333; color: white; font-family: monospace;}
        .sync-btn-group { display: flex; gap: 10px; }
        .sync-btn { padding: 10px 20px; background: #e50914; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; flex: 1; transition: 0.2s;}
        .sync-btn:hover { background: #ff0a16; }
        .sync-btn.import { background: #28a745; }
        .sync-btn.import:hover { background: #218838; }
        
        .movie-card { position: relative; }
        .delete-btn {
            position: absolute; top: 5px; left: 5px; background: rgba(229, 9, 20, 0.9);
            color: white; border: none; border-radius: 50%; width: 25px; height: 25px;
            font-size: 12px; font-weight: bold; cursor: pointer; z-index: 20; display: flex;
            align-items: center; justify-content: center; transition: 0.2s;
        }
        .delete-btn:hover { transform: scale(1.1); background: #ff0a16; }
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="logo">NETFLIX FAKE</a>
        <div class="header-links">
            <a href="index.html">üè† Trang ch·ªß</a>
        </div>
    </header>

    <div class="container">
        <div class="sync-box">
            <h3>üîÑ ƒê·ªìng b·ªô K√©p (M√£ Si√™u Ng·∫Øn)</h3>
            <p style="font-size: 14px; color: #bbb; margin-top: 0;">M√£ n√†y ch·ª©a to√†n b·ªô <b>T·ªß Phim</b>, <b>L·ªãch s·ª≠ ƒëang xem</b> v√† <b>S·ªë gi√¢y xem d·ªü</b>. T·ª± ƒë·ªông Copy khi b·∫•m "L·∫•y M√£".</p>
            <input type="text" id="syncCodeInput" placeholder="D√°n m√£ ƒë·ªìng b·ªô v√†o ƒë√¢y...">
            <div class="sync-btn-group">
                <button class="sync-btn" onclick="exportCode()">üì§ L·∫•y M√£ C·ªßa T√¥i</button>
                <button class="sync-btn import" onclick="importCode()">üì• Nh·∫≠p M√£ Ph·ª•c H·ªìi</button>
            </div>
        </div>

        <h2 class="section-title">‚ù§Ô∏è Phim ƒê√£ L∆∞u</h2>
        <div class="movie-grid" id="savedGrid"></div>
    </div>

    <script>
        const savedGrid = document.getElementById('savedGrid');
        const syncCodeInput = document.getElementById('syncCodeInput');
        
        // ================= HI·ªÇN TH·ªä V√Ä X√ìA T·ª¶ PHIM =================
        function loadSavedMovies() {
            const savedMovies = JSON.parse(localStorage.getItem('savedMovies')) || {};
            savedGrid.innerHTML = '';
            
            const slugs = Object.keys(savedMovies);
            if (slugs.length === 0) {
                savedGrid.innerHTML = '<p style="color: #aaa;">B·∫°n ch∆∞a l∆∞u b·ªô phim n√†o v√†o t·ªß.</p>';
                return;
            }

            slugs.reverse().forEach(slug => {
                const movie = savedMovies[slug];
                const card = document.createElement('div');
                card.classList.add('movie-card');
                card.innerHTML = `
                    <button class="delete-btn" onclick="deleteMovie('${slug}')" title="X√≥a kh·ªèi t·ªß phim">‚úï</button>
                    <a href="detail.html?slug=${slug}" style="text-decoration: none; color: inherit; display: block;">
                        <img src="${movie.thumb}" alt="${movie.name}" class="movie-poster" loading="lazy" onerror="this.src='https://via.placeholder.com/160x240?text=No+Image'">
                        <div class="movie-info">
                            <div class="movie-title">${movie.name}</div>
                            <div class="movie-year">${movie.year || 'ƒêang c·∫≠p nh·∫≠t'}</div>
                        </div>
                    </a>
                `;
                savedGrid.appendChild(card);
            });
        }

        window.deleteMovie = function(slug) {
            if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a phim n√†y kh·ªèi T·ªß Phim?')) {
                let savedMovies = JSON.parse(localStorage.getItem('savedMovies')) || {};
                delete savedMovies[slug]; 
                localStorage.setItem('savedMovies', JSON.stringify(savedMovies));
                loadSavedMovies(); 
            }
        };

        // ================= XU·∫§T M√É ƒê·ªíNG B·ªò √âP XUNG (SI√äU NG·∫ÆN) =================
        window.exportCode = function() {
            const saved = JSON.parse(localStorage.getItem('savedMovies')) || {};
            const history = JSON.parse(localStorage.getItem('watchHistory')) || {};
            const progress = JSON.parse(localStorage.getItem('videoProgress')) || {};

            // 1. T·ªß phim c√°ch nhau b·∫±ng d·∫•u ph·∫©y
            const sSlugs = Object.keys(saved).join(',');

            // 2. L·ªãch s·ª≠ d·∫°ng: id:t·∫≠p:s·ªë_gi√¢y (VD: venom:3:120)
            const hItems = Object.keys(history).map(slug => {
                let ep = history[slug].epName ? history[slug].epName.replace('T·∫≠p ', '').replace('Full', 'F').trim() : '';
                let p = progress[slug] || 0;
                return `${slug}:${ep}:${p}`;
            }).join(',');

            // D·∫•u * ngƒÉn c√°ch gi·ªØa T·ªß Phim v√† L·ªãch S·ª≠
            const code = `${sSlugs}*${hItems}`;
            if (code === '*') return alert("B·∫°n ch∆∞a c√≥ T·ªß Phim hay L·ªãch s·ª≠ n√†o ƒë·ªÉ xu·∫•t!");

            syncCodeInput.value = code;
            try {
                navigator.clipboard.writeText(code);
                alert("ƒê√£ COPY M√É TH√ÄNH C√îNG!");
            } catch(e) {
                alert("ƒê√£ t·∫°o m√£! Vui l√≤ng b√¥i ƒëen v√† copy ƒëo·∫°n m√£ trong √¥ nh√©.");
            }
        };

        // ================= NH·∫¨P M√É ƒê·ªíNG B·ªò √âP XUNG =================
        window.importCode = async function() {
            const code = syncCodeInput.value.trim();
            if (!code) return alert("Vui l√≤ng d√°n m√£ ƒë·ªìng b·ªô v√†o √¥ tr·ªëng!");
            if (!code.includes('*')) return alert("M√£ kh√¥ng h·ª£p l·ªá! Vui l√≤ng ki·ªÉm tra l·∫°i.");
            
            try {
                const parts = code.split('*');
                const savedSlugs = parts[0] ? parts[0].split(',') : [];
                const histItems = parts[1] ? parts[1].split(',') : [];
                
                syncCodeInput.value = '‚è≥ ƒêang t·∫£i l·∫°i d·ªØ li·ªáu...';
                
                let currentSaved = JSON.parse(localStorage.getItem('savedMovies')) || {};
                let currentHist = JSON.parse(localStorage.getItem('watchHistory')) || {};
                let currentProg = JSON.parse(localStorage.getItem('videoProgress')) || {};

                // H√†m h·ªó tr·ª£ g·ªçi OPhim ƒë·ªÉ l·∫•y l·∫°i ·∫£nh + t√™n phim b·ªã thi·∫øu do n√©n m√£
                async function getMovieInfo(slug) {
                    try {
                        const res = await fetch(`https://ophim1.com/v1/api/phim/${slug}`);
                        const data = await res.json();
                        if(data.status === 'success' && data.data && data.data.item) {
                            const m = data.data.item;
                            const imgDomain = data.data.APP_DOMAIN_CDN_IMAGE || 'https://img.ophim.live';
                            let posterUrl = m.thumb_url || m.poster_url;
                            if (posterUrl && !posterUrl.startsWith('http')) posterUrl = `${imgDomain}/uploads/movies/${posterUrl}`;
                            return { name: m.name, thumb: posterUrl, year: m.year };
                        }
                    } catch(e) {}
                    return null;
                }

                // 1. Ph·ª•c h·ªìi T·ªß Phim
                for(let slug of savedSlugs) {
                    if(slug && !currentSaved[slug]) {
                        const info = await getMovieInfo(slug);
                        if(info) currentSaved[slug] = info;
                    }
                }

                // 2. Ph·ª•c h·ªìi L·ªãch S·ª≠ T·∫≠p v√† S·ªë Gi√¢y ƒëang xem d·ªü
                for(let item of histItems) {
                    if(item) {
                        const [slug, ep, p] = item.split(':');
                        if(slug) {
                            const info = currentSaved[slug] || await getMovieInfo(slug);
                            if(info) {
                                let epNameFormated = ep === 'F' ? 'Full' : (ep ? 'T·∫≠p ' + ep : 'T·∫≠p ?');
                                currentHist[slug] = {
                                    name: info.name, thumb: info.thumb, year: info.year,
                                    epName: epNameFormated, time: Date.now()
                                };
                                if (parseInt(p) > 0) currentProg[slug] = parseInt(p);
                            }
                        }
                    }
                }

                // L∆∞u t·∫•t c·∫£ v√†o b·ªô nh·ªõ tr√¨nh duy·ªát
                localStorage.setItem('savedMovies', JSON.stringify(currentSaved));
                localStorage.setItem('watchHistory', JSON.stringify(currentHist));
                localStorage.setItem('videoProgress', JSON.stringify(currentProg));
                
                loadSavedMovies();
                syncCodeInput.value = '';
                alert("üéâ ƒê·ªíNG B·ªò TH√ÄNH C√îNG!\nK√©o sang Trang Ch·ªß ƒë·ªÉ xem L·ªãch S·ª≠ nh√©.");

            } catch (e) {
                alert("M√£ l·ªói ho·∫∑c m√°y ch·ªß phim ƒëang qu√° t·∫£i. Vui l√≤ng th·ª≠ l·∫°i sau!");
                syncCodeInput.value = '';
            }
        };

        // Kh·ªüi ch·∫°y khi m·ªü trang
        loadSavedMovies();
    </script>
</body>
</html>