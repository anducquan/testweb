<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·ªß Phim C·ªßa T√¥i</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .header-links a { color: white; margin-left: 20px; font-weight: bold; }
        .sync-box { background: #333; padding: 20px; border-radius: 10px; margin-bottom: 30px; }
        .sync-box input { padding: 10px; width: 60%; border-radius: 5px; border: none; outline: none; margin-right: 10px;}
        .sync-btn { padding: 10px 20px; background: #e50914; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;}
        
        .movie-card { position: relative; }
        .delete-btn {
            position: absolute; top: 5px; left: 5px; background: rgba(229, 9, 20, 0.9);
            color: white; border: none; border-radius: 50%; width: 25px; height: 25px;
            font-size: 12px; font-weight: bold; cursor: pointer; z-index: 20; display: flex;
            align-items: center; justify-content: center; transition: 0.2s;
        }
        .delete-btn:hover { transform: scale(1.1); background: #ff0a16; }
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="logo">NETFLIX FAKE</a>
        <div class="header-links">
            <a href="index.html">üè† Trang ch·ªß</a>
        </div>
    </header>

    <div class="container">
        <h2 class="section-title">Phim ƒê√£ L∆∞u</h2>
        
        <div class="sync-box">
            <h3>ƒê·ªìng b·ªô K√©p (T·ªß Phim & L·ªãch S·ª≠)</h3>
            <p style="font-size: 14px; color: #bbb;">M√£ n√†y ch·ª©a c·∫£ danh s√°ch phim y√™u th√≠ch v√† phim b·∫°n ƒëang xem d·ªü. T·ª± ƒë·ªông Copy khi b·∫•m "L·∫•y M√£".</p>
            <input type="text" id="syncCodeInput" placeholder="D√°n m√£ ƒë·ªìng b·ªô v√†o ƒë√¢y...">
            <button class="sync-btn" onclick="exportCode()">L·∫•y M√£ C·ªßa T√¥i</button>
            <button class="sync-btn" style="background: #28a745;" onclick="importCode()">Nh·∫≠p M√£</button>
        </div>

        <div class="movie-grid" id="savedGrid"></div>
    </div>

    <script>
        const savedGrid = document.getElementById('savedGrid');
        const syncCodeInput = document.getElementById('syncCodeInput');
        
        function loadSavedMovies() {
            const savedMovies = JSON.parse(localStorage.getItem('savedMovies')) || {};
            savedGrid.innerHTML = '';
            
            const slugs = Object.keys(savedMovies);
            if (slugs.length === 0) {
                savedGrid.innerHTML = '<p>B·∫°n ch∆∞a l∆∞u b·ªô phim n√†o.</p>';
                return;
            }

            slugs.forEach(slug => {
                const movie = savedMovies[slug];
                const card = document.createElement('div');
                card.classList.add('movie-card');
                card.innerHTML = `
                    <button class="delete-btn" onclick="deleteMovie('${slug}')" title="X√≥a kh·ªèi t·ªß phim">‚úï</button>
                    <a href="detail.html?slug=${slug}" style="text-decoration: none; color: inherit; display: block;">
                        <img src="${movie.thumb}" alt="${movie.name}" class="movie-poster" loading="lazy" onerror="this.src='https://via.placeholder.com/160x240?text=No+Image'">
                        <div class="movie-info">
                            <div class="movie-title">${movie.name}</div>
                            <div class="movie-year">${movie.year || ''}</div>
                        </div>
                    </a>
                `;
                savedGrid.appendChild(card);
            });
        }

        function deleteMovie(slug) {
            if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a phim n√†y kh·ªèi T·ªß Phim?')) {
                let savedMovies = JSON.parse(localStorage.getItem('savedMovies')) || {};
                delete savedMovies[slug]; 
                localStorage.setItem('savedMovies', JSON.stringify(savedMovies));
                loadSavedMovies(); 
            }
        }

        // ================= XU·∫§T M√É K√âP (N√âN D·ªÆ LI·ªÜU) =================
        function exportCode() {
            const savedMovies = JSON.parse(localStorage.getItem('savedMovies')) || {};
            const watchHistory = JSON.parse(localStorage.getItem('watchHistory')) || {};
            
            const savedSlugs = Object.keys(savedMovies).join(','); // D·∫°ng: phim-A,phim-B
            
            // X·ª≠ l√Ω L·ªãch s·ª≠ (ƒê√≥ng g√≥i ID, T·∫≠p, Th·ªùi gian)
            const histArr = Object.keys(watchHistory).map(slug => {
                const h = watchHistory[slug];
                return `${slug}|${h.epName}|${h.time}`; // D·∫°ng: phim-C|T·∫≠p 3|17000000
            });
            const histStr = histArr.join(',');

            const finalData = `${savedSlugs}@@${histStr}`; // NgƒÉn c√°ch 2 m·∫£ng b·∫±ng @@
            
            if (finalData === '@@') return alert("B·∫°n ch∆∞a c√≥ T·ªß Phim hay L·ªãch s·ª≠ n√†o ƒë·ªÉ ƒë·ªìng b·ªô!");

            const code = btoa(finalData); 
            syncCodeInput.value = code;

            try {
                navigator.clipboard.writeText(code);
                alert("ƒê√£ T·ª∞ ƒê·ªòNG COPY m√£ ƒê·ªìng B·ªô K√©p!\nB·∫°n c√≥ th·ªÉ d√°n sang m√°y kh√°c ƒë·ªÉ kh√¥i ph·ª•c c·∫£ T·ªß Phim v√† L·ªãch s·ª≠ ƒëang xem.");
            } catch(e) {
                alert("ƒê√£ t·∫°o m√£! Vui l√≤ng b√¥i ƒëen v√† copy ƒëo·∫°n m√£ trong √¥.");
            }
        }

        // ================= NH·∫¨P M√É TH√îNG MINH =================
        async function importCode() {
            const code = syncCodeInput.value.trim();
            if (!code) return alert("Vui l√≤ng d√°n m√£ ƒë·ªìng b·ªô v√†o √¥ tr·ªëng!");
            
            try {
                let decoded = atob(code);
                // H·ªó tr·ª£ m√£ c≈© (ch∆∞a c√≥ d·∫•u @@)
                if (!decoded.includes('@@')) decoded = decoded + '@@';
                
                const parts = decoded.split('@@');
                const savedSlugs = parts[0] ? parts[0].split(',') : [];
                const histItems = parts[1] ? parts[1].split(',') : [];
                
                syncCodeInput.value = 'ƒêang k√©o d·ªØ li·ªáu v·ªÅ m√°y... Vui l√≤ng ƒë·ª£i!';
                
                let currentSaved = JSON.parse(localStorage.getItem('savedMovies')) || {};
                let currentHist = JSON.parse(localStorage.getItem('watchHistory')) || {};

                // H√†m h·ªó tr·ª£ g·ªçi API r√∫t g·ªçn
                async function fetchMovieData(slug) {
                    try {
                        const res = await fetch(`https://ophim1.com/v1/api/phim/${slug}`);
                        const data = await res.json();
                        if(data.status === 'success' && data.data && data.data.item) {
                            const m = data.data.item;
                            const imgDomain = data.data.APP_DOMAIN_CDN_IMAGE || 'https://img.ophim.live';
                            let posterUrl = m.thumb_url || m.poster_url;
                            if (posterUrl && !posterUrl.startsWith('http')) posterUrl = `${imgDomain}/uploads/movies/${posterUrl}`;
                            return { name: m.name, thumb: posterUrl, year: m.year };
                        }
                    } catch (err) {}
                    return null;
                }

                // 1. Ph·ª•c h·ªìi T·ªß Phim
                for(let slug of savedSlugs) {
                    if(slug && !currentSaved[slug]) {
                        const mData = await fetchMovieData(slug);
                        if(mData) currentSaved[slug] = mData;
                    }
                }

                // 2. Ph·ª•c h·ªìi L·ªãch S·ª≠ ƒêang Xem
                for(let item of histItems) {
                    if (item) {
                        const [slug, epName, timeStr] = item.split('|');
                        if(slug && !currentHist[slug]) {
                            const mData = await fetchMovieData(slug);
                            if(mData) {
                                currentHist[slug] = {
                                    name: mData.name,
                                    thumb: mData.thumb,
                                    year: mData.year,
                                    epName: epName || "T·∫≠p ?",
                                    time: parseInt(timeStr) || Date.now()
                                };
                            }
                        }
                    }
                }

                localStorage.setItem('savedMovies', JSON.stringify(currentSaved));
                localStorage.setItem('watchHistory', JSON.stringify(currentHist));
                
                loadSavedMovies();
                syncCodeInput.value = '';
                alert("ƒê·ªìng b·ªô th√†nh c√¥ng! H√£y ra Trang ch·ªß ƒë·ªÉ xem L·ªãch s·ª≠ v·ª´a ƒë∆∞·ª£c c·∫≠p nh·∫≠t.");

            } catch (e) {
                alert("M√£ kh√¥ng h·ª£p l·ªá! Vui l√≤ng ki·ªÉm tra l·∫°i.");
                syncCodeInput.value = '';
            }
        }

        loadSavedMovies();
    </script>
</body>
</html>