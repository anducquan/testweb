<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ƒêang xem phim</title>
    <script src="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100dvh; background: #000; overflow: hidden; position: fixed; top: 0; left: 0; }
        .artplayer-app { position: absolute; top: 0; bottom: 0; left: 0; right: 0; width: 100%; height: 100%; padding-bottom: env(safe-area-inset-bottom); z-index: 1;}
        .back-btn { position: absolute; top: 15px; left: 15px; z-index: 9999; background: rgba(0,0,0,0.6); color: white; padding: 8px 15px; border-radius: 5px; text-decoration: none; font-family: sans-serif; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2); }
        .error-msg { color: white; text-align: center; padding-top: 100px; font-family: sans-serif; display: none; position: relative; z-index: 10;}
        
        /* CSS CHO PANEL DANH S√ÅCH T·∫¨P */
        .episodes-panel { position: fixed; top: 0; right: -300px; width: 280px; height: 100%; background: rgba(15, 15, 15, 0.95); backdrop-filter: blur(10px); z-index: 99999; transition: right 0.3s ease; padding: 20px 15px; box-sizing: border-box; overflow-y: auto; color: white; border-left: 1px solid rgba(255,255,255,0.1); font-family: sans-serif; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; }
        .episodes-panel.open { right: 0; }
        .ep-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 5px; }
        .ep-header h3 { margin: 0; font-size: 18px; color: #e50914;}
        .ep-close-btn { background: transparent; color: white; border: 1px solid #555; padding: 5px 10px; border-radius: 5px; cursor: pointer; transition: 0.2s;}
        .ep-close-btn:hover { background: #e50914; border-color: #e50914;}
        .ep-list-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .ep-item { background: #333; padding: 10px 5px; border-radius: 5px; text-decoration: none; color: white; text-align: center; font-size: 14px; transition: 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .ep-item:hover { background: #555; }
        .ep-item.active { background: #e50914; font-weight: bold; pointer-events: none; box-shadow: 0 0 10px rgba(229,9,20,0.5);}

        /* ================= T·ªêI ∆ØU RESPONSIVE CHO ƒêI·ªÜN THO·∫†I ================= */
        @media (max-width: 768px) {
            /* ·∫®n thanh √¢m l∆∞·ª£ng tr√™n ƒëi·ªán tho·∫°i ƒë·ªÉ ti·∫øt ki·ªám di·ªán t√≠ch (ƒêT ƒë√£ c√≥ ph√≠m c·ª©ng) */
            .art-control-volume { display: none !important; }
            /* Thu h·∫πp kho·∫£ng c√°ch c√°c n√∫t b√™n d∆∞·ªõi */
            .art-video-player .art-bottom .art-control { padding: 0 5px !important; }
            /* Thu nh·ªè ch·ªØ */
            .mobile-hide-text { display: none; } 
        }
    </style>
</head>
<body>
    <a href="#" class="back-btn" id="backBtn">‚Üê Quay l·∫°i</a>
    
    <div class="artplayer-app" id="player-container"></div>
    <div class="error-msg" id="error-msg"><h2>Kh√¥ng t√¨m th·∫•y ngu·ªìn ph√°t!</h2></div>

    <div class="episodes-panel" id="episodesPanel">
        <div class="ep-header">
            <h3>Danh s√°ch t·∫≠p</h3>
            <button class="ep-close-btn" onclick="document.getElementById('episodesPanel').classList.remove('open')">ƒê√≥ng ‚úï</button>
        </div>
        <div class="ep-list-container" id="epListContainer">
            <p style="grid-column: span 2; text-align: center; color: #aaa;">ƒêang t·∫£i...</p>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        let videoUrl = decodeURIComponent(urlParams.get('url'));
        let slug = urlParams.get('slug'); 

        // G·∫Øn link cho n√∫t Quay L·∫°i
        if (slug) {
            document.getElementById('backBtn').href = 'detail.html?slug=' + slug;
        } else {
            document.getElementById('backBtn').href = 'index.html';
        }

        if (!videoUrl || videoUrl === 'null') {
            document.getElementById('error-msg').style.display = 'block';
        } else {
            var art = new Artplayer({
                container: '.artplayer-app',
                url: videoUrl,
                type: 'm3u8',
                volume: 1, autoplay: true, pip: true, setting: true, playbackRate: true, aspectRatio: true, flip: true,         
                
                fullscreen: !/iPhone|iPad|iPod/i.test(navigator.userAgent), 
                fullscreenWeb: true, 
                
                playsInline: true, autoOrientation: true, lockDeviceOrientation: true, theme: '#e50914',
                controls: [
                    {
                        position: 'right',
                        html: '<svg viewBox="0 0 1024 1024" width="20" height="20" fill="#fff"><path d="M853.333 768h-170.666v-85.333h170.666v-512h-682.666v512h170.666v85.333h-170.666c-46.934 0-85.334-38.4-85.334-85.333v-512c0-46.933 38.4-85.333 85.334-85.333h682.666c46.933 0 85.333 38.4 85.333 85.333v512c0 46.933-38.4 85.333-85.333 85.333zM512 682.667l-170.667 170.666h341.334l-170.667-170.666z"></path></svg>',
                        tooltip: 'ƒê·∫ßu ra √Çm thanh',
                        click: function () {
                            if (art.video.webkitShowPlaybackTargetPicker) art.video.webkitShowPlaybackTargetPicker();
                            else art.notice.show = 'T√≠nh nƒÉng n√†y ch·ªâ h·ªó tr·ª£ thi·∫øt b·ªã iOS';
                        }
                    }
                ],
                customType: {
                    m3u8: function (video, url, art) {
                        if (Hls.isSupported()) {
                            const hls = new Hls({ enableWorker: true, capLevelToPlayerSize: true, maxBufferLength: 15, maxMaxBufferLength: 30, startLevel: -1 });
                            hls.loadSource(url); hls.attachMedia(video); art.hls = hls;
                            hls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
                                if (data.levels.length > 1) {
                                    let quality = data.levels.map((l, i) => ({ default: i === data.levels.length - 1, html: l.height + 'P', level: i }));
                                    art.setting.add({ html: 'Ch·∫•t l∆∞·ª£ng', selector: quality, onSelect: function (item) { hls.currentLevel = item.level; return item.html; } });
                                }
                            });
                            art.on('destroy', () => hls.destroy());
                        } else if (video.canPlayType('application/vnd.apple.mpegurl')) { video.src = url; }
                    },
                },
            });

            // ================= FIX T√çNH NƒÇNG C·∫¢M ·ª®NG (DOUBLE TAP 5S & VU·ªêT) =================
            let touchStartX = 0;
            let touchStartY = 0;
            let touchStartTime = 0;
            let targetTime = 0;
            let isSwiping = false;
            let lastTouchTime = 0;

            art.on('ready', () => {
                const app = art.template.$player; 

                app.addEventListener('touchstart', (e) => {
                    // ƒê√É FIX: Ch·ªâ ch·∫∑n vu·ªët n·∫øu ch·∫°m v√†o thanh ti·∫øn tr√¨nh ho·∫∑c c√°c n√∫t b·∫•m b√™n d∆∞·ªõi/b√™n trong panel
                    if (e.target.closest('.art-bottom') || e.target.closest('.art-controls') || e.target.closest('.art-setting-panel') || e.target.closest('.episodes-panel')) {
                        return; 
                    }

                    const now = Date.now();
                    
                    // --- T√çNH NƒÇNG DOUBLE TAP D2 TUA 5S ---
                    if (now - lastTouchTime < 300) {
                        const rect = app.getBoundingClientRect();
                        const touchX = e.touches[0].clientX - rect.left;
                        
                        if (touchX > rect.width * 0.6) { 
                            art.currentTime += 5; 
                            art.notice.show = '‚è© +5 Gi√¢y';
                            art.play(); // FIX CH·ªêNG D·ª™NG: √âp video ch·∫°y ti·∫øp
                            e.preventDefault(); 
                            lastTouchTime = 0; 
                            return;
                        } 
                        else if (touchX < rect.width * 0.4) { 
                            art.currentTime -= 5; 
                            art.notice.show = '‚è™ -5 Gi√¢y';
                            art.play(); // FIX CH·ªêNG D·ª™NG: √âp video ch·∫°y ti·∫øp
                            e.preventDefault(); 
                            lastTouchTime = 0; 
                            return;
                        }
                    }
                    lastTouchTime = now;

                    // --- CHU·∫®N B·ªä CHO T√çNH NƒÇNG VU·ªêT ---
                    if (e.touches.length === 1) { 
                        touchStartX = e.touches[0].clientX;
                        touchStartY = e.touches[0].clientY;
                        touchStartTime = art.currentTime;
                        isSwiping = false;
                    }
                }, { passive: false });

                app.addEventListener('touchmove', (e) => {
                    if (e.target.closest('.art-bottom') || e.target.closest('.art-controls') || e.touches.length !== 1) return;

                    let deltaX = e.touches[0].clientX - touchStartX;
                    let deltaY = e.touches[0].clientY - touchStartY;

                    // Vu·ªët ngang d√†i h∆°n vu·ªët d·ªçc -> K√≠ch ho·∫°t tua
                    if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 20) {
                        isSwiping = true;
                        targetTime = touchStartTime + (deltaX * 0.5); 
                        
                        if (targetTime < 0) targetTime = 0;
                        if (targetTime > art.duration) targetTime = art.duration;
                        
                        let mins = Math.floor(targetTime / 60);
                        let secs = Math.floor(targetTime % 60).toString().padStart(2, '0');
                        let sign = deltaX > 0 ? "‚è© Tua t·ªõi" : "‚è™ Tua lui";
                        art.notice.show = `${sign}: ${mins}:${secs}`;
                        
                        e.preventDefault();
                    }
                }, { passive: false });

                app.addEventListener('touchend', (e) => {
                    if (isSwiping) {
                        art.currentTime = targetTime; 
                        isSwiping = false;
                        e.preventDefault();
                    }
                });
            });

            // ================= L∆ØU TH·ªúI GIAN THEO T·ª™NG T·∫¨P =================
            if (slug) {
                let progressData = JSON.parse(localStorage.getItem('videoProgress')) || {};
                let epKey = slug + '_' + btoa(videoUrl).substring(0, 15); 
                
                if (progressData[epKey] && progressData[epKey] > 0) {
                    art.once('ready', () => {
                        art.currentTime = progressData[epKey];
                        art.notice.show = `ƒê√£ t·ª± ƒë·ªông tua ƒë·∫øn ph√∫t ${Math.floor(progressData[epKey] / 60)}`;
                    });
                }

                art.on('video:timeupdate', () => {
                    let currentTime = Math.floor(art.currentTime);
                    if (currentTime % 5 === 0 && currentTime > 0) {
                        progressData[epKey] = currentTime;
                        localStorage.setItem('videoProgress', JSON.stringify(progressData));
                    }
                });

                // ================= T·∫†O MENU T·∫¨P V√Ä N√öT QUA T·∫¨P =================
                Promise.all([
                    fetch(`https://ophim1.com/v1/api/phim/${slug}`).catch(() => null),
                    fetch(`https://phimapi.com/phim/${slug}`).catch(() => null),
                    fetch(`https://phim.nguonc.com/api/film/${slug}`).catch(() => null)
                ]).then(async ([resOphim, resKK, resNguonC]) => {
                    let combinedEpisodes = [];
                    
                    if (resOphim) {
                        let data = await resOphim.json().catch(()=>null);
                        let eps = data?.data?.item?.episodes || data?.episodes || [];
                        eps.forEach(sv => { if(sv.server_data?.length > 0) { sv.server_name += " (Ophim)"; combinedEpisodes.push(sv); }});
                    }
                    if (resKK) {
                        let data = await resKK.json().catch(()=>null);
                        let eps = data?.episodes || data?.movie?.episodes || data?.data?.item?.episodes || [];
                        eps.forEach(sv => { if(sv.server_data?.length > 0) { sv.server_name += " (KKPhim)"; combinedEpisodes.push(sv); }});
                    }
                    if (resNguonC) {
                        let data = await resNguonC.json().catch(()=>null);
                        let eps = data?.episodes || data?.movie?.episodes || data?.item?.episodes || data?.data?.item?.episodes || [];
                        eps.forEach(sv => { if(sv.server_data?.length > 0) { sv.server_name += " (NguonC)"; combinedEpisodes.push(sv); }});
                    }

                    if (combinedEpisodes.length > 0) {
                        const epListContainer = document.getElementById('epListContainer');
                        epListContainer.innerHTML = '';
                        
                        let currentServerIndex = -1;
                        let currentEpIndex = -1;
                        
                        for (let s = 0; s < combinedEpisodes.length; s++) {
                            const sData = combinedEpisodes[s].server_data;
                            for (let e = 0; e < sData.length; e++) {
                                if (sData[e].link_m3u8 === videoUrl) {
                                    currentServerIndex = s; currentEpIndex = e; break;
                                }
                            }
                            if (currentServerIndex !== -1) break;
                        }

                        // ƒê√É T·ªêI ∆ØU TEXT: ·∫®n ch·ªØ th·ª´a tr√™n ƒëi·ªán tho·∫°i ƒë·ªÉ tr√°nh b·ªã tr√†n
                        art.controls.add({
                            position: 'right',
                            html: '<span style="font-size: 14px; font-weight: bold; cursor: pointer;">üì∫ <span class="mobile-hide-text">Ch·ªçn </span>T·∫≠p</span>',
                            tooltip: 'Danh s√°ch t·∫≠p phim',
                            click: function () { document.getElementById('episodesPanel').classList.add('open'); }
                        });

                        combinedEpisodes.forEach((server, sIdx) => {
                            epListContainer.innerHTML += `<div style="grid-column: span 2; font-weight: bold; color: #e50914; margin-top: 15px; border-bottom: 1px solid #444; padding-bottom: 5px; font-size: 14px;">‚ñ∂ ${server.server_name}</div>`;
                            server.server_data.forEach((ep, eIdx) => {
                                const isActive = (sIdx === currentServerIndex && eIdx === currentEpIndex) ? 'active' : '';
                                const epUrl = `watch.html?url=${encodeURIComponent(ep.link_m3u8)}&slug=${slug}`;
                                const epName = ep.name.replace('T·∫≠p ', 'T'); 
                                epListContainer.innerHTML += `<a href="${epUrl}" class="ep-item ${isActive}">${epName}</a>`;
                            });
                        });

                        if (currentServerIndex !== -1 && currentEpIndex !== -1) {
                            const currentServerData = combinedEpisodes[currentServerIndex].server_data;
                            
                            let history = JSON.parse(localStorage.getItem('watchHistory')) || {};
                            if (history[slug]) {
                                history[slug].epName = `${currentServerData[currentEpIndex].name} ${combinedEpisodes[currentServerIndex].server_name}`;
                                localStorage.setItem('watchHistory', JSON.stringify(history));
                            }

                            if (currentEpIndex < currentServerData.length - 1) {
                                const nextEp = currentServerData[currentEpIndex + 1];
                                const nextEpUrl = `watch.html?url=${encodeURIComponent(nextEp.link_m3u8)}&slug=${slug}`;
                                
                                art.controls.add({
                                    position: 'right',
                                    html: '<span style="font-size: 14px; font-weight: bold; cursor: pointer; color: #e50914;">‚è≠Ô∏è <span class="mobile-hide-text">T·∫≠p </span>Ti·∫øp</span>',
                                    tooltip: 'Chuy·ªÉn t·∫≠p',
                                    click: function () { window.location.href = nextEpUrl; }
                                });

                                art.on('video:ended', () => {
                                    art.notice.show = 'ƒêang t·ª± ƒë·ªông chuy·ªÉn...';
                                    setTimeout(() => { window.location.href = nextEpUrl; }, 3000); 
                                });
                            }
                        }
                    }
                }).catch(err => console.error(err));
            }
        }
    </script>
</body>
</html>
