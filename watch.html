<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Đang xem phim</title>
    <script src="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        /* Khóa chặt body vào màn hình, hỗ trợ 100dvh cho mobile đời mới */
        body, html { 
            margin: 0; padding: 0; 
            width: 100%; height: 100%; height: 100dvh; 
            background-color: #000; overflow: hidden; 
            position: fixed; top: 0; left: 0;
        }
        
        /* Khung video ép full 100% không cho tràn */
        .artplayer-app { 
            position: absolute; top: 0; bottom: 0; left: 0; right: 0;
            width: 100%; height: 100%; 
            padding-bottom: env(safe-area-inset-bottom); /* Né dải đen vuốt Home trên iPhone */
        }
        
        .back-btn { 
            position: absolute; top: 15px; left: 15px; z-index: 9999; 
            background: rgba(0,0,0,0.6); color: white; padding: 8px 15px; 
            border-radius: 5px; text-decoration: none; font-family: sans-serif; 
            backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2);
        }
        .error-msg { color: white; text-align: center; padding-top: 100px; font-family: sans-serif; display: none; position: relative; z-index: 10;}
    </style>
</head>
<body>
    <a href="javascript:history.back()" class="back-btn">← Quay lại</a>
    
    <div class="artplayer-app" id="player-container"></div>
    <div class="error-msg" id="error-msg"><h2>Không tìm thấy nguồn phát!</h2></div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        let videoUrl = decodeURIComponent(urlParams.get('url'));

        if (!videoUrl || videoUrl === 'null') {
            document.getElementById('error-msg').style.display = 'block';
        } else {
            var art = new Artplayer({
                container: '.artplayer-app',
                url: videoUrl,
                type: 'm3u8',
                volume: 1, 
                autoplay: true, 
                pip: true, 
                screenshot: true, 
                setting: true, 
                playbackRate: true, 
                aspectRatio: true,  
                flip: true,         
                fullscreen: true, 
                fullscreenWeb: true, 
                playsInline: true, 
                autoSize: true, // Ép video tự co giãn vừa khung
                autoOrientation: true, // Xoay ngang màn hình
                lockDeviceOrientation: true, // Khóa màn hình khi full
                theme: '#e50914',
                customType: {
                    m3u8: function (video, url, art) {
                        if (Hls.isSupported()) {
                            const hls = new Hls();
                            hls.loadSource(url);
                            hls.attachMedia(video);
                            art.hls = hls;
                            
                            hls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
                                if (data.levels.length > 1) {
                                    let quality = data.levels.map((level, index) => ({
                                        default: index === data.levels.length - 1,
                                        html: level.height + 'P',
                                        level: index,
                                    }));
                                    art.setting.add({
                                        html: 'Chất lượng',
                                        selector: quality,
                                        onSelect: function (item) {
                                            hls.currentLevel = item.level;
                                            return item.html;
                                        },
                                    });
                                }
                            });
                            art.on('destroy', () => hls.destroy());
                        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                            video.src = url;
                        } else { 
                            art.notice.show = 'Trình duyệt không hỗ trợ HLS'; 
                        }
                    },
                },
            });
        }
    </script>
</body>
</html>