<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Đang xem phim</title>
    <script src="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100dvh; background: #000; overflow: hidden; position: fixed; top: 0; left: 0; }
        .artplayer-app { position: absolute; top: 0; bottom: 0; left: 0; right: 0; width: 100%; height: 100%; padding-bottom: env(safe-area-inset-bottom); z-index: 1;}
        .back-btn { position: absolute; top: 15px; left: 15px; z-index: 9999; background: rgba(0,0,0,0.6); color: white; padding: 8px 15px; border-radius: 5px; text-decoration: none; font-family: sans-serif; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2); }
        .error-msg { color: white; text-align: center; padding-top: 100px; font-family: sans-serif; display: none; position: relative; z-index: 10;}
    </style>
</head>
<body>
    <a href="javascript:history.back()" class="back-btn">← Quay lại</a>
    
    <div class="artplayer-app" id="player-container"></div>
    <div class="error-msg" id="error-msg"><h2>Không tìm thấy nguồn phát!</h2></div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        let videoUrl = decodeURIComponent(urlParams.get('url'));
        let slug = urlParams.get('slug'); 

        if (!videoUrl || videoUrl === 'null') {
            document.getElementById('error-msg').style.display = 'block';
        } else {
            var art = new Artplayer({
                container: '.artplayer-app',
                url: videoUrl,
                type: 'm3u8',
                volume: 1, 
                autoplay: true, 
                pip: true, 
                setting: true, 
                playbackRate: true, 
                aspectRatio: true,  
                flip: true,         
                
                // ĐÃ FIX: Bật lại Fullscreen gốc và tắt AutoSize
                fullscreen: true, 
                fullscreenWeb: true, 
                // autoSize: true, ---> ĐÃ XÓA DÒNG GÂY LỖI NÀY
                
                playsInline: true, 
                autoOrientation: true, 
                lockDeviceOrientation: true, 
                theme: '#e50914',

                // NÚT ĐỔI ÂM THANH / AIRPLAY
                controls: [
                    {
                        position: 'right',
                        html: '<svg viewBox="0 0 1024 1024" width="22" height="22" fill="#fff"><path d="M853.333 768h-170.666v-85.333h170.666v-512h-682.666v512h170.666v85.333h-170.666c-46.934 0-85.334-38.4-85.334-85.333v-512c0-46.933 38.4-85.333 85.334-85.333h682.666c46.933 0 85.333 38.4 85.333 85.333v512c0 46.933-38.4 85.333-85.333 85.333zM512 682.667l-170.667 170.666h341.334l-170.667-170.666z"></path></svg>',
                        tooltip: 'Đầu ra Âm thanh',
                        click: function () {
                            const video = art.video;
                            if (video.webkitShowPlaybackTargetPicker) {
                                video.webkitShowPlaybackTargetPicker(); // Bảng đổi loa/tai nghe iPhone
                            } else {
                                art.notice.show('Tính năng này chỉ hỗ trợ trên thiết bị iOS (iPhone/iPad)');
                            }
                        }
                    }
                ],

                customType: {
                    m3u8: function (video, url, art) {
                        if (Hls.isSupported()) {
                            // CẤU HÌNH TỐI ƯU LOAD NHANH
                            const hls = new Hls({
                                enableWorker: true,
                                capLevelToPlayerSize: true,
                                maxBufferLength: 15,
                                maxMaxBufferLength: 30,
                                startLevel: -1
                            });
                            
                            hls.loadSource(url);
                            hls.attachMedia(video);
                            art.hls = hls;
                            
                            // Load danh sách chọn chất lượng (1080p, 720p...)
                            hls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
                                if (data.levels.length > 1) {
                                    let quality = data.levels.map((level, index) => ({
                                        default: index === data.levels.length - 1,
                                        html: level.height + 'P',
                                        level: index,
                                    }));
                                    art.setting.add({
                                        html: 'Chất lượng',
                                        selector: quality,
                                        onSelect: function (item) {
                                            hls.currentLevel = item.level;
                                            return item.html;
                                        },
                                    });
                                }
                            });
                            art.on('destroy', () => hls.destroy());
                        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                            video.src = url;
                        } else { 
                            art.notice.show = 'Trình duyệt không hỗ trợ HLS'; 
                        }
                    },
                },
            });

            // ================= LƯU THỜI GIAN VÀO TRÌNH DUYỆT =================
            if (slug) {
                let progressData = JSON.parse(localStorage.getItem('videoProgress')) || {};
                
                if (progressData[slug] && progressData[slug] > 0) {
                    art.once('ready', () => {
                        art.currentTime = progressData[slug];
                        art.notice.show = `Đã tự động tua đến phút ${Math.floor(progressData[slug] / 60)}`;
                    });
                }

                art.on('video:timeupdate', () => {
                    let currentTime = Math.floor(art.currentTime);
                    if (currentTime % 5 === 0 && currentTime > 0) {
                        progressData[slug] = currentTime;
                        localStorage.setItem('videoProgress', JSON.stringify(progressData));
                    }
                });
            }
        }
    </script>
</body>
</html>
