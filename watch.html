<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ƒêang xem phim</title>
    <script src="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100dvh; background: #000; overflow: hidden; position: fixed; top: 0; left: 0; }
        .artplayer-app { position: absolute; top: 0; bottom: 0; left: 0; right: 0; width: 100%; height: 100%; padding-bottom: env(safe-area-inset-bottom); z-index: 1;}
        .back-btn { position: absolute; top: 15px; left: 15px; z-index: 9999; background: rgba(0,0,0,0.6); color: white; padding: 8px 15px; border-radius: 5px; text-decoration: none; font-family: sans-serif; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2); }
        .error-msg { color: white; text-align: center; padding-top: 100px; font-family: sans-serif; display: none; position: relative; z-index: 10;}
        
        /* CSS CHO PANEL DANH S√ÅCH T·∫¨P */
        .episodes-panel {
            position: fixed; top: 0; right: -300px; width: 280px; height: 100%;
            background: rgba(15, 15, 15, 0.95); backdrop-filter: blur(10px);
            z-index: 99999; transition: right 0.3s ease; padding: 20px 15px;
            box-sizing: border-box; overflow-y: auto; color: white;
            border-left: 1px solid rgba(255,255,255,0.1); font-family: sans-serif;
        }
        .episodes-panel.open { right: 0; }
        .ep-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 15px; }
        .ep-header h3 { margin: 0; font-size: 18px; color: #e50914;}
        .ep-close-btn { background: transparent; color: white; border: 1px solid #555; padding: 5px 10px; border-radius: 5px; cursor: pointer; transition: 0.2s;}
        .ep-close-btn:hover { background: #e50914; border-color: #e50914;}
        .ep-list-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .ep-item { background: #333; padding: 10px 5px; border-radius: 5px; text-decoration: none; color: white; text-align: center; font-size: 14px; transition: 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .ep-item:hover { background: #555; }
        .ep-item.active { background: #e50914; font-weight: bold; pointer-events: none; box-shadow: 0 0 10px rgba(229,9,20,0.5);}
    </style>
</head>
<body>
    <a href="javascript:history.back()" class="back-btn">‚Üê Quay l·∫°i</a>
    
    <div class="artplayer-app" id="player-container"></div>
    <div class="error-msg" id="error-msg"><h2>Kh√¥ng t√¨m th·∫•y ngu·ªìn ph√°t!</h2></div>

    <div class="episodes-panel" id="episodesPanel">
        <div class="ep-header">
            <h3>Danh s√°ch t·∫≠p</h3>
            <button class="ep-close-btn" onclick="document.getElementById('episodesPanel').classList.remove('open')">ƒê√≥ng ‚úï</button>
        </div>
        <div class="ep-list-container" id="epListContainer">
            <p style="grid-column: span 2; text-align: center; color: #aaa;">ƒêang t·∫£i...</p>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        let videoUrl = decodeURIComponent(urlParams.get('url'));
        let slug = urlParams.get('slug'); 

        if (!videoUrl || videoUrl === 'null') {
            document.getElementById('error-msg').style.display = 'block';
        } else {
            var art = new Artplayer({
                container: '.artplayer-app',
                url: videoUrl,
                type: 'm3u8',
                volume: 1, 
                autoplay: true, 
                pip: true, 
                setting: true, 
                playbackRate: true, 
                aspectRatio: true,  
                flip: true,         
                // T·∫Øt Fullscreen g·ªëc tr√™n iOS ƒë·ªÉ Apple kh√¥ng c∆∞·ªõp tr√¨nh ph√°t
                fullscreen: !/iPhone|iPad|iPod/i.test(navigator.userAgent), 
                // B·∫≠t Fullscreen c·ªßa Web (ph√≥ng to l·∫•p ƒë·∫ßy m√†n h√¨nh tr√¨nh duy·ªát)
                fullscreenWeb: true,
                playsInline: true, 
                autoOrientation: true, 
                lockDeviceOrientation: true, 
                theme: '#e50914',

                // N√öT ƒê·ªîI √ÇM THANH / AIRPLAY
                controls: [
                    {
                        position: 'right',
                        html: '<svg viewBox="0 0 1024 1024" width="22" height="22" fill="#fff"><path d="M853.333 768h-170.666v-85.333h170.666v-512h-682.666v512h170.666v85.333h-170.666c-46.934 0-85.334-38.4-85.334-85.333v-512c0-46.933 38.4-85.333 85.334-85.333h682.666c46.933 0 85.333 38.4 85.333 85.333v512c0 46.933-38.4 85.333-85.333 85.333zM512 682.667l-170.667 170.666h341.334l-170.667-170.666z"></path></svg>',
                        tooltip: 'ƒê·∫ßu ra √Çm thanh',
                        click: function () {
                            const video = art.video;
                            if (video.webkitShowPlaybackTargetPicker) {
                                video.webkitShowPlaybackTargetPicker();
                            } else {
                                art.notice.show = 'T√≠nh nƒÉng n√†y ch·ªâ h·ªó tr·ª£ tr√™n thi·∫øt b·ªã iOS (iPhone/iPad)';
                            }
                        }
                    }
                ],

                customType: {
                    m3u8: function (video, url, art) {
                        if (Hls.isSupported()) {
                            const hls = new Hls({
                                enableWorker: true,
                                capLevelToPlayerSize: true,
                                maxBufferLength: 15,
                                maxMaxBufferLength: 30,
                                startLevel: -1
                            });
                            
                            hls.loadSource(url);
                            hls.attachMedia(video);
                            art.hls = hls;
                            
                            hls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
                                if (data.levels.length > 1) {
                                    let quality = data.levels.map((level, index) => ({
                                        default: index === data.levels.length - 1,
                                        html: level.height + 'P',
                                        level: index,
                                    }));
                                    art.setting.add({
                                        html: 'Ch·∫•t l∆∞·ª£ng',
                                        selector: quality,
                                        onSelect: function (item) {
                                            hls.currentLevel = item.level;
                                            return item.html;
                                        },
                                    });
                                }
                            });
                            art.on('destroy', () => hls.destroy());
                        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                            video.src = url;
                        } else { 
                            art.notice.show = 'Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ HLS'; 
                        }
                    },
                },
            });

            // ================= L∆ØU TH·ªúI GIAN V√ÄO TR√åNH DUY·ªÜT =================
            if (slug) {
                let progressData = JSON.parse(localStorage.getItem('videoProgress')) || {};
                
                if (progressData[slug] && progressData[slug] > 0) {
                    art.once('ready', () => {
                        art.currentTime = progressData[slug];
                        art.notice.show = `ƒê√£ t·ª± ƒë·ªông tua ƒë·∫øn ph√∫t ${Math.floor(progressData[slug] / 60)}`;
                    });
                }

                art.on('video:timeupdate', () => {
                    let currentTime = Math.floor(art.currentTime);
                    if (currentTime % 5 === 0 && currentTime > 0) {
                        progressData[slug] = currentTime;
                        localStorage.setItem('videoProgress', JSON.stringify(progressData));
                    }
                });

                // ================= G·ªåI API ƒê·ªÇ L√ÄM DANH S√ÅCH T·∫¨P & CHUY·ªÇN T·∫¨P =================
                fetch(`https://ophim1.com/v1/api/phim/${slug}`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success' || data.status === true) {
                        const movie = (data.data && data.data.item) ? data.data.item : data.movie;
                        const episodes = (data.data && data.data.item && data.data.item.episodes) ? data.data.item.episodes : [];
                        
                        if (episodes.length > 0) {
                            const serverData = episodes[0].server_data;
                            let currentIndex = -1;
                            
                            // T√¨m v·ªã tr√≠ t·∫≠p ƒëang ph√°t
                            for (let i = 0; i < serverData.length; i++) {
                                if (serverData[i].link_m3u8 === videoUrl) {
                                    currentIndex = i;
                                    break;
                                }
                            }

                            // 1. G·∫Øn n√∫t M·ªü Danh S√°ch T·∫≠p v√†o tr√¨nh ph√°t
                            art.controls.add({
                                position: 'right',
                                html: '<span style="font-size: 14px; font-weight: bold; padding: 0 10px; cursor: pointer;">üì∫ Ch·ªçn t·∫≠p</span>',
                                tooltip: 'Danh s√°ch t·∫≠p phim',
                                click: function () {
                                    document.getElementById('episodesPanel').classList.add('open');
                                }
                            });

                            // 2. Render danh s√°ch t·∫≠p ra thanh Panel
                            const epListContainer = document.getElementById('epListContainer');
                            epListContainer.innerHTML = '';
                            serverData.forEach((ep, index) => {
                                const isActive = index === currentIndex ? 'active' : '';
                                const epUrl = `watch.html?url=${encodeURIComponent(ep.link_m3u8)}&slug=${slug}`;
                                // Format t√™n t·∫≠p cho g·ªçn
                                const epName = ep.name.replace('T·∫≠p ', 'T'); 
                                epListContainer.innerHTML += `<a href="${epUrl}" class="ep-item ${isActive}">${epName}</a>`;
                            });

                            // 3. X·ª≠ l√Ω T·∫≠p Ti·∫øp Theo
                            if (currentIndex !== -1) {
                                // C·∫≠p nh·∫≠t L·ªãch S·ª≠ Xem (T√™n t·∫≠p hi·ªán t·∫°i) ƒë·ªÉ khi ra Home th·∫•y ƒë√∫ng t·∫≠p ƒëang xem
                                let history = JSON.parse(localStorage.getItem('watchHistory')) || {};
                                if (history[slug]) {
                                    history[slug].epName = serverData[currentIndex].name;
                                    localStorage.setItem('watchHistory', JSON.stringify(history));
                                }

                                // N·∫øu ch∆∞a ph·∫£i t·∫≠p cu·ªëi
                                if (currentIndex < serverData.length - 1) {
                                    const nextEp = serverData[currentIndex + 1];
                                    const nextEpUrl = `watch.html?url=${encodeURIComponent(nextEp.link_m3u8)}&slug=${slug}`;
                                    
                                    // Th√™m n√∫t Qua T·∫≠p tr√™n tr√¨nh ph√°t
                                    art.controls.add({
                                        position: 'right',
                                        html: '<span style="font-size: 14px; font-weight: bold; padding: 0 10px; cursor: pointer; color: #e50914;">‚è≠Ô∏è T·∫≠p ti·∫øp</span>',
                                        tooltip: 'Chuy·ªÉn t·∫≠p ' + nextEp.name,
                                        click: function () {
                                            window.location.href = nextEpUrl;
                                        }
                                    });

                                    // T·ª± ƒë·ªông nh·∫£y t·∫≠p khi video ch·∫°y h·∫øt
                                    art.on('video:ended', () => {
                                        art.notice.show = 'ƒêang t·ª± ƒë·ªông chuy·ªÉn ' + nextEp.name + '...';
                                        setTimeout(() => {
                                            window.location.href = nextEpUrl;
                                        }, 3000); // Ch·ªù 3 gi√¢y r·ªìi chuy·ªÉn
                                    });
                                }
                            }
                        }
                    }
                })
                .catch(err => console.error("L·ªói API t·∫≠p phim:", err));
            }
        }
    </script>
</body>
</html>
